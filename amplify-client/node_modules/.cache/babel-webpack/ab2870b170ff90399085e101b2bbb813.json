{"ast":null,"code":"/**\r\n * DevExtreme (ui/drop_down_box.js)\r\n * Version: 19.2.6\r\n * Build date: Thu Jan 30 2020\r\n *\r\n * Copyright (c) 2012 - 2020 Developer Express Inc. ALL RIGHTS RESERVED\r\n * Read about DevExtreme licensing here: https://js.devexpress.com/Licensing/\r\n */\n\"use strict\";\n\nvar _ui = require(\"./drop_down_editor/ui.drop_down_editor\");\n\nvar _ui2 = _interopRequireDefault(_ui);\n\nvar _ui3 = require(\"./editor/ui.data_expression\");\n\nvar _ui4 = _interopRequireDefault(_ui3);\n\nvar _common = require(\"../core/utils/common\");\n\nvar _type = require(\"../core/utils/type\");\n\nvar _iterator = require(\"../core/utils/iterator\");\n\nvar _selectors = require(\"./widget/selectors\");\n\nvar _selectors2 = _interopRequireDefault(_selectors);\n\nvar _ui5 = require(\"./widget/ui.keyboard_processor\");\n\nvar _ui6 = _interopRequireDefault(_ui5);\n\nvar _deferred = require(\"../core/utils/deferred\");\n\nvar _renderer = require(\"../core/renderer\");\n\nvar _renderer2 = _interopRequireDefault(_renderer);\n\nvar _events_engine = require(\"../events/core/events_engine\");\n\nvar _events_engine2 = _interopRequireDefault(_events_engine);\n\nvar _extend = require(\"../core/utils/extend\");\n\nvar _utils = require(\"../ui/overlay/utils\");\n\nvar _component_registrator = require(\"../core/component_registrator\");\n\nvar _component_registrator2 = _interopRequireDefault(_component_registrator);\n\nvar _utils2 = require(\"../events/utils\");\n\nvar _devices = require(\"../core/devices\");\n\nvar _devices2 = _interopRequireDefault(_devices);\n\nvar _dom_adapter = require(\"../core/dom_adapter\");\n\nfunction _interopRequireDefault(obj) {\n  return obj && obj.__esModule ? obj : {\n    \"default\": obj\n  };\n}\n\nvar DROP_DOWN_BOX_CLASS = \"dx-dropdownbox\";\nvar ANONYMOUS_TEMPLATE_NAME = \"content\";\n\nvar realDevice = _devices2.default.real();\n\nvar DropDownBox = _ui2.default.inherit({\n  _supportedKeys: function _supportedKeys() {\n    return (0, _extend.extend)({}, this.callBase(), {\n      tab: function tab(e) {\n        if (!this.option(\"opened\")) {\n          return;\n        }\n\n        var $tabbableElements = this._getTabbableElements();\n\n        var $focusableElement = e.shiftKey ? $tabbableElements.last() : $tabbableElements.first();\n        $focusableElement && _events_engine2.default.trigger($focusableElement, \"focus\");\n        e.preventDefault();\n      }\n    });\n  },\n  _getTabbableElements: function _getTabbableElements() {\n    return this._getElements().filter(_selectors2.default.tabbable);\n  },\n  _getElements: function _getElements() {\n    return (0, _renderer2.default)(this.content()).find(\"*\");\n  },\n  _getAnonymousTemplateName: function _getAnonymousTemplateName() {\n    return ANONYMOUS_TEMPLATE_NAME;\n  },\n  _getDefaultOptions: function _getDefaultOptions() {\n    return (0, _extend.extend)(this.callBase(), {\n      acceptCustomValue: false,\n      contentTemplate: \"content\",\n      openOnFieldClick: true,\n      displayValueFormatter: function displayValueFormatter(value) {\n        return Array.isArray(value) ? value.join(\", \") : value;\n      },\n      useHiddenSubmitElement: true\n    });\n  },\n  _initMarkup: function _initMarkup() {\n    this._initDataExpressions();\n\n    this.$element().addClass(DROP_DOWN_BOX_CLASS);\n    this.callBase();\n  },\n  _setSubmitValue: function _setSubmitValue() {\n    var value = this.option(\"value\");\n    var submitValue = this._shouldUseDisplayValue(value) ? this._displayGetter(value) : value;\n\n    this._getSubmitElement().val(submitValue);\n  },\n  _shouldUseDisplayValue: function _shouldUseDisplayValue(value) {\n    return \"this\" === this.option(\"valueExpr\") && (0, _type.isObject)(value);\n  },\n  _renderInputValue: function _renderInputValue() {\n    var callBase = this.callBase.bind(this);\n    var values = [];\n\n    if (!this._dataSource) {\n      callBase(values);\n      return new _deferred.Deferred().resolve();\n    }\n\n    var currentValue = this._getCurrentValue();\n\n    var keys = (0, _common.ensureDefined)(currentValue, []);\n    keys = Array.isArray(keys) ? keys : [keys];\n    var itemLoadDeferreds = (0, _iterator.map)(keys, function (key) {\n      return this._loadItem(key).always(function (item) {\n        var displayValue = this._displayGetter(item);\n\n        values.push((0, _common.ensureDefined)(displayValue, key));\n      }.bind(this));\n    }.bind(this));\n    return _deferred.when.apply(this, itemLoadDeferreds).always(function () {\n      this.option(\"displayValue\", values);\n      callBase(values.length && values);\n    }.bind(this)).fail(callBase);\n  },\n  _loadItem: function _loadItem(value) {\n    var deferred = new _deferred.Deferred();\n    var that = this;\n    var selectedItem = (0, _common.grep)(this.option(\"items\") || [], function (item) {\n      return this._isValueEquals(this._valueGetter(item), value);\n    }.bind(this))[0];\n\n    if (void 0 !== selectedItem) {\n      deferred.resolve(selectedItem);\n    } else {\n      this._loadValue(value).done(function (item) {\n        deferred.resolve(item);\n      }).fail(function (args) {\n        if (that.option(\"acceptCustomValue\")) {\n          deferred.resolve(value);\n        } else {\n          deferred.reject();\n        }\n      });\n    }\n\n    return deferred.promise();\n  },\n  _updatePopupWidth: function _updatePopupWidth() {\n    this._setPopupOption(\"width\", this.$element().outerWidth());\n  },\n  _popupElementTabHandler: function _popupElementTabHandler(e) {\n    if (\"tab\" !== (0, _utils2.normalizeKeyName)(e)) {\n      return;\n    }\n\n    var $firstTabbable = this._getTabbableElements().first().get(0);\n\n    var $lastTabbable = this._getTabbableElements().last().get(0);\n\n    var $target = e.originalEvent.target;\n    var moveBackward = !!($target === $firstTabbable && e.shift);\n    var moveForward = !!($target === $lastTabbable && !e.shift);\n\n    if (moveBackward || moveForward) {\n      this.close();\n\n      _events_engine2.default.trigger(this._input(), \"focus\");\n\n      if (moveBackward) {\n        e.originalEvent.preventDefault();\n      }\n    }\n  },\n  _renderPopup: function _renderPopup(e) {\n    this.callBase();\n\n    if (this.option(\"focusStateEnabled\")) {\n      this._popup._keyboardProcessor.push(new _ui6.default({\n        element: this.content(),\n        handler: this._popupElementTabHandler,\n        context: this\n      }));\n    }\n  },\n  _renderPopupContent: function _renderPopupContent() {\n    if (this.option(\"contentTemplate\") === ANONYMOUS_TEMPLATE_NAME) {\n      return;\n    }\n\n    return this.callBase();\n  },\n  _canShowVirtualKeyboard: function _canShowVirtualKeyboard() {\n    return realDevice.mac;\n  },\n  _isNestedElementActive: function _isNestedElementActive() {\n    var activeElement = (0, _dom_adapter.getActiveElement)();\n    return activeElement && this._popup.$content().get(0).contains(activeElement);\n  },\n  _shouldCloseOnTargetScroll: function _shouldCloseOnTargetScroll() {\n    return \"desktop\" === realDevice.deviceType && this._canShowVirtualKeyboard() && this._isNestedElementActive();\n  },\n  _popupConfig: function _popupConfig() {\n    var _this = this;\n\n    var horizontalAlignment = this.option(\"rtlEnabled\") ? \"right\" : \"left\";\n    return (0, _extend.extend)(this.callBase(), {\n      width: function () {\n        return this.$element().outerWidth();\n      }.bind(this),\n      height: \"auto\",\n      tabIndex: -1,\n      dragEnabled: false,\n      focusStateEnabled: this.option(\"focusStateEnabled\"),\n      closeOnTargetScroll: this._shouldCloseOnTargetScroll.bind(this),\n      position: {\n        of: this.$element(),\n        collision: \"flipfit\",\n        my: \"top \" + horizontalAlignment,\n        at: \"bottom \" + horizontalAlignment,\n        offset: {\n          y: -1\n        }\n      },\n      onKeyboardHandled: function onKeyboardHandled(opts) {\n        return _this.option(\"focusStateEnabled\") && _this._popupElementTabHandler(opts);\n      },\n      maxHeight: function () {\n        return (0, _utils.getElementMaxHeightByWindow)(this.$element());\n      }.bind(this)\n    });\n  },\n  _popupShownHandler: function _popupShownHandler() {\n    this.callBase();\n\n    var $firstElement = this._getTabbableElements().first();\n\n    _events_engine2.default.trigger($firstElement, \"focus\");\n  },\n  _setCollectionWidgetOption: _common.noop,\n  _optionChanged: function _optionChanged(args) {\n    this._dataExpressionOptionChanged(args);\n\n    switch (args.name) {\n      case \"width\":\n        this.callBase(args);\n        this._popup && this._popup.repaint();\n        break;\n\n      case \"dataSource\":\n        this._renderInputValue();\n\n        break;\n\n      case \"displayValue\":\n        this.option(\"text\", args.value);\n        break;\n\n      case \"displayExpr\":\n        this._renderValue();\n\n        break;\n\n      default:\n        this.callBase(args);\n    }\n  }\n}).include(_ui4.default);\n\n(0, _component_registrator2.default)(\"dxDropDownBox\", DropDownBox);\nmodule.exports = DropDownBox;\nmodule.exports.default = module.exports;","map":null,"metadata":{},"sourceType":"script"}