{"ast":null,"code":"/**\r\n * DevExtreme (ui/tree_list/ui.tree_list.selection.js)\r\n * Version: 19.2.6\r\n * Build date: Thu Jan 30 2020\r\n *\r\n * Copyright (c) 2012 - 2020 Developer Express Inc. ALL RIGHTS RESERVED\r\n * Read about DevExtreme licensing here: https://js.devexpress.com/Licensing/\r\n */\n\"use strict\";\n\nvar _renderer = require(\"../../core/renderer\");\n\nvar _renderer2 = _interopRequireDefault(_renderer);\n\nvar _uiTree_list = require(\"./ui.tree_list.core\");\n\nvar _uiTree_list2 = _interopRequireDefault(_uiTree_list);\n\nvar _common = require(\"../../core/utils/common\");\n\nvar _uiGrid_core = require(\"../grid_core/ui.grid_core.selection\");\n\nvar _uiGrid_core2 = _interopRequireDefault(_uiGrid_core);\n\nvar _ui = require(\"../widget/ui.errors\");\n\nvar _ui2 = _interopRequireDefault(_ui);\n\nvar _extend = require(\"../../core/utils/extend\");\n\nfunction _interopRequireDefault(obj) {\n  return obj && obj.__esModule ? obj : {\n    \"default\": obj\n  };\n}\n\nvar TREELIST_SELECT_ALL_CLASS = \"dx-treelist-select-all\";\nvar CELL_FOCUS_DISABLED_CLASS = \"dx-cell-focus-disabled\";\nvar SELECT_CHECKBOX_CLASS = \"dx-select-checkbox\";\nvar originalRowClick = _uiGrid_core2.default.extenders.views.rowsView._rowClick;\nvar originalHandleDataChanged = _uiGrid_core2.default.extenders.controllers.data._handleDataChanged;\n\nvar nodeExists = function nodeExists(array, currentKey) {\n  return !!array.filter(function (key) {\n    return key === currentKey;\n  }).length;\n};\n\n_uiTree_list2.default.registerModule(\"selection\", (0, _extend.extend)(true, {}, _uiGrid_core2.default, {\n  defaultOptions: function defaultOptions() {\n    return (0, _extend.extend)(true, _uiGrid_core2.default.defaultOptions(), {\n      selection: {\n        showCheckBoxesMode: \"always\",\n        recursive: false\n      }\n    });\n  },\n  extenders: {\n    controllers: {\n      data: {\n        _handleDataChanged: function _handleDataChanged(e) {\n          var selectionController = this.getController(\"selection\");\n          var isRecursiveSelection = selectionController.isRecursiveSelection();\n\n          if (isRecursiveSelection && (!e || \"updateSelectionState\" !== e.changeType)) {\n            selectionController.updateSelectionState({\n              selectedItemKeys: this.option(\"selectedRowKeys\")\n            });\n          }\n\n          originalHandleDataChanged.apply(this, arguments);\n        },\n        loadDescendants: function loadDescendants() {\n          var that = this;\n          var d = that.callBase.apply(that, arguments);\n          var selectionController = that.getController(\"selection\");\n          var isRecursiveSelection = selectionController.isRecursiveSelection();\n\n          if (isRecursiveSelection) {\n            d.done(function () {\n              selectionController.updateSelectionState({\n                selectedItemKeys: that.option(\"selectedRowKeys\")\n              });\n            });\n          }\n\n          return d;\n        }\n      },\n      selection: {\n        init: function init() {\n          this.callBase.apply(this, arguments);\n          this._selectionStateByKey = {};\n        },\n        _getSelectionConfig: function _getSelectionConfig() {\n          var _arguments = arguments,\n              _this = this;\n\n          var config = this.callBase.apply(this, arguments);\n          var plainItems = config.plainItems;\n\n          config.plainItems = function (all) {\n            if (all) {\n              return _this._dataController.getCachedStoreData() || [];\n            }\n\n            return plainItems.apply(_this, _arguments).map(function (item) {\n              return item.data;\n            });\n          };\n\n          config.isItemSelected = function (item) {\n            var key = _this._dataController.keyOf(item);\n\n            return _this.isRowSelected(key);\n          };\n\n          config.isSelectableItem = function () {\n            return true;\n          };\n\n          config.getItemData = function (item) {\n            return item;\n          };\n\n          return config;\n        },\n        renderSelectCheckBoxContainer: function renderSelectCheckBoxContainer($container, model) {\n          var that = this;\n          var rowsView = that.component.getView(\"rowsView\");\n          $container.addClass(CELL_FOCUS_DISABLED_CLASS);\n\n          var $checkbox = rowsView._renderSelectCheckBox($container, {\n            value: model.row.isSelected,\n            row: model.row,\n            column: model.column\n          });\n\n          rowsView._attachCheckBoxClickEvent($checkbox);\n        },\n        _updateSelectColumn: _common.noop,\n        _getVisibleNodeKeys: function _getVisibleNodeKeys(isRecursiveSelection) {\n          var component = this.component;\n          var root = component.getRootNode();\n          var cache = {};\n          var keys = [];\n          root && _uiTree_list2.default.foreachNodes(root.children, function (node) {\n            if (void 0 !== node.key && (node.visible || isRecursiveSelection)) {\n              keys.push(node.key);\n            }\n\n            return isRecursiveSelection ? false : component.isRowExpanded(node.key, cache);\n          });\n          return keys;\n        },\n        isSelectAll: function isSelectAll() {\n          var component = this.component;\n          var hasIndeterminateState;\n\n          var visibleKeys = this._getVisibleNodeKeys();\n\n          var selectedVisibleKeys = visibleKeys.filter(function (key) {\n            return component.isRowSelected(key);\n          });\n\n          if (!selectedVisibleKeys.length) {\n            hasIndeterminateState = visibleKeys.some(function (key) {\n              return void 0 === component.isRowSelected(key);\n            });\n            return hasIndeterminateState ? void 0 : false;\n          } else {\n            if (selectedVisibleKeys.length === visibleKeys.length) {\n              return true;\n            }\n          }\n        },\n        selectAll: function selectAll() {\n          var that = this;\n          var isRecursiveSelection = that.isRecursiveSelection();\n\n          var visibleKeys = that._getVisibleNodeKeys(isRecursiveSelection).filter(function (key) {\n            return !that.isRowSelected(key);\n          });\n\n          return that.selectRows(visibleKeys, true);\n        },\n        deselectAll: function deselectAll() {\n          var isRecursiveSelection = this.isRecursiveSelection();\n\n          var visibleKeys = this._getVisibleNodeKeys(isRecursiveSelection);\n\n          return this.deselectRows(visibleKeys);\n        },\n        selectedItemKeys: function selectedItemKeys(value, preserve, isDeselect, isSelectAll) {\n          var that = this;\n          var selectedRowKeys = that.option(\"selectedRowKeys\");\n          var isRecursiveSelection = this.isRecursiveSelection();\n\n          var normalizedArgs = isRecursiveSelection && that._normalizeSelectionArgs({\n            keys: value || []\n          }, !isDeselect);\n\n          if (normalizedArgs && !(0, _common.equalByValue)(normalizedArgs.selectedRowKeys, selectedRowKeys)) {\n            that._isSelectionNormalizing = true;\n            return this.callBase(normalizedArgs.selectedRowKeys, false, false, false).always(function () {\n              that._isSelectionNormalizing = false;\n            }).done(function (items) {\n              normalizedArgs.selectedRowsData = items;\n\n              that._fireSelectionChanged(normalizedArgs);\n            });\n          }\n\n          return this.callBase(value, preserve, isDeselect, isSelectAll);\n        },\n        changeItemSelection: function changeItemSelection(itemIndex, keyboardKeys) {\n          var isRecursiveSelection = this.isRecursiveSelection();\n\n          if (isRecursiveSelection && !keyboardKeys.shift) {\n            var key = this._dataController.getKeyByRowIndex(itemIndex);\n\n            return this.selectedItemKeys(key, true, this.isRowSelected(key));\n          }\n\n          return this.callBase.apply(this, arguments);\n        },\n        _updateParentSelectionState: function _updateParentSelectionState(node, isSelected) {\n          var that = this;\n          var state = isSelected;\n          var parentNode = node.parent;\n          var hasNonSelectedState;\n          var hasSelectedState;\n\n          if (parentNode) {\n            if (parentNode.children.length > 1) {\n              if (false === isSelected) {\n                hasSelectedState = parentNode.children.some(function (childNode, index, children) {\n                  return that._selectionStateByKey[childNode.key];\n                });\n                state = hasSelectedState ? void 0 : false;\n              } else {\n                if (true === isSelected) {\n                  hasNonSelectedState = parentNode.children.some(function (childNode) {\n                    return !that._selectionStateByKey[childNode.key];\n                  });\n                  state = hasNonSelectedState ? void 0 : true;\n                }\n              }\n            }\n\n            this._selectionStateByKey[parentNode.key] = state;\n\n            if (parentNode.parent && parentNode.parent.level >= 0) {\n              this._updateParentSelectionState(parentNode, state);\n            }\n          }\n        },\n        _updateChildrenSelectionState: function _updateChildrenSelectionState(node, isSelected) {\n          var that = this;\n          var children = node.children;\n          children && children.forEach(function (childNode) {\n            that._selectionStateByKey[childNode.key] = isSelected;\n\n            if (childNode.children.length > 0) {\n              that._updateChildrenSelectionState(childNode, isSelected);\n            }\n          });\n        },\n        _updateSelectionStateCore: function _updateSelectionStateCore(keys, isSelected) {\n          var node;\n          var dataController = this._dataController;\n\n          for (var i = 0; i < keys.length; i++) {\n            this._selectionStateByKey[keys[i]] = isSelected;\n            node = dataController.getNodeByKey(keys[i]);\n\n            if (node) {\n              this._updateParentSelectionState(node, isSelected);\n\n              this._updateChildrenSelectionState(node, isSelected);\n            }\n          }\n        },\n        _getSelectedParentKeys: function _getSelectedParentKeys(key, selectedItemKeys, useCash) {\n          var isSelected;\n          var selectedParentNode;\n\n          var node = this._dataController.getNodeByKey(key);\n\n          var parentNode = node && node.parent;\n          var result = [];\n\n          while (parentNode && parentNode.level >= 0) {\n            result.unshift(parentNode.key);\n            isSelected = useCash ? !nodeExists(selectedItemKeys, parentNode.key) && this.isRowSelected(parentNode.key) : selectedItemKeys.indexOf(parentNode.key) >= 0;\n\n            if (isSelected) {\n              selectedParentNode = parentNode;\n              result = this._getSelectedParentKeys(selectedParentNode.key, selectedItemKeys, useCash).concat(result);\n              break;\n            } else {\n              if (useCash) {\n                break;\n              }\n            }\n\n            parentNode = parentNode.parent;\n          }\n\n          return selectedParentNode && result || [];\n        },\n        _getSelectedChildKeys: function _getSelectedChildKeys(node, keysToIgnore) {\n          var that = this;\n          var childKeys = [];\n          node && _uiTree_list2.default.foreachNodes(node.children, function (childNode) {\n            var ignoreKeyIndex = keysToIgnore.indexOf(childNode.key);\n\n            if (ignoreKeyIndex < 0) {\n              childKeys.push(childNode.key);\n            }\n\n            return ignoreKeyIndex > 0 || ignoreKeyIndex < 0 && void 0 === that._selectionStateByKey[childNode.key];\n          });\n          return childKeys;\n        },\n        _normalizeParentKeys: function _normalizeParentKeys(key, args) {\n          var that = this;\n          var index;\n          var childKeys;\n          var parentNode;\n          var keysToIgnore = [key];\n\n          var parentNodeKeys = that._getSelectedParentKeys(key, args.selectedRowKeys);\n\n          if (parentNodeKeys.length) {\n            keysToIgnore = keysToIgnore.concat(parentNodeKeys);\n            keysToIgnore.forEach(function (key) {\n              index = args.selectedRowKeys.indexOf(key);\n\n              if (index >= 0) {\n                args.selectedRowKeys.splice(index, 1);\n              }\n            });\n            parentNode = that._dataController.getNodeByKey(parentNodeKeys[0]);\n            childKeys = that._getSelectedChildKeys(parentNode, keysToIgnore);\n            args.selectedRowKeys = args.selectedRowKeys.concat(childKeys);\n          }\n        },\n        _normalizeChildrenKeys: function _normalizeChildrenKeys(key, args) {\n          var that = this;\n          var index;\n\n          var node = that._dataController.getNodeByKey(key);\n\n          node && node.children.forEach(function (childNode) {\n            index = args.selectedRowKeys.indexOf(childNode.key);\n\n            if (index >= 0) {\n              args.selectedRowKeys.splice(index, 1);\n            }\n\n            that._normalizeChildrenKeys(childNode.key, args);\n          });\n        },\n        _normalizeSelectedRowKeysCore: function _normalizeSelectedRowKeysCore(keys, args, isSelect) {\n          var that = this;\n          var index;\n          keys.forEach(function (key) {\n            if (that.isRowSelected(key) === isSelect) {\n              return;\n            }\n\n            that._normalizeChildrenKeys(key, args);\n\n            index = args.selectedRowKeys.indexOf(key);\n\n            if (isSelect) {\n              if (index < 0) {\n                args.selectedRowKeys.push(key);\n              }\n\n              args.currentSelectedRowKeys.push(key);\n            } else {\n              if (index >= 0) {\n                args.selectedRowKeys.splice(index, 1);\n              }\n\n              args.currentDeselectedRowKeys.push(key);\n\n              that._normalizeParentKeys(key, args);\n            }\n          });\n        },\n        _normalizeSelectionArgs: function _normalizeSelectionArgs(args, isSelect) {\n          var result;\n          var keys = Array.isArray(args.keys) ? args.keys : [args.keys];\n          var selectedRowKeys = this.option(\"selectedRowKeys\") || [];\n\n          if (keys.length) {\n            result = {\n              currentSelectedRowKeys: [],\n              currentDeselectedRowKeys: [],\n              selectedRowKeys: selectedRowKeys.slice(0)\n            };\n\n            this._normalizeSelectedRowKeysCore(keys, result, isSelect);\n          }\n\n          return result;\n        },\n        _updateSelectedItems: function _updateSelectedItems(args) {\n          this.updateSelectionState(args);\n          this.callBase(args);\n        },\n        _fireSelectionChanged: function _fireSelectionChanged() {\n          if (!this._isSelectionNormalizing) {\n            this.callBase.apply(this, arguments);\n          }\n        },\n        _isModeLeavesOnly: function _isModeLeavesOnly(mode) {\n          return \"leavesOnly\" === mode || true === mode;\n        },\n        _getAllSelectedRowKeys: function _getAllSelectedRowKeys(parentKeys) {\n          var that = this;\n          var result = [];\n          parentKeys.forEach(function (key) {\n            var insertIndex = result.length;\n\n            var parentKeys = that._getSelectedParentKeys(key, result, true);\n\n            var childKeys = that._dataController.getChildNodeKeys(key);\n\n            result.splice.apply(result, [insertIndex, 0].concat(parentKeys));\n            result.push(key);\n            result = result.concat(childKeys);\n          });\n          return result;\n        },\n        _getParentSelectedRowKeys: function _getParentSelectedRowKeys(keys) {\n          var that = this;\n          var result = [];\n          keys.forEach(function (key) {\n            var parentKeys = that._getSelectedParentKeys(key, keys);\n\n            !parentKeys.length && result.push(key);\n          });\n          return result;\n        },\n        _getLeafSelectedRowKeys: function _getLeafSelectedRowKeys(keys) {\n          var that = this;\n          var result = [];\n          var dataController = that._dataController;\n          keys.forEach(function (key) {\n            var node = dataController.getNodeByKey(key);\n            node && !node.hasChildren && result.push(key);\n          });\n          return result;\n        },\n        isRecursiveSelection: function isRecursiveSelection() {\n          var selectionMode = this.option(\"selection.mode\");\n          var isRecursive = this.option(\"selection.recursive\");\n          return \"multiple\" === selectionMode && isRecursive;\n        },\n        updateSelectionState: function updateSelectionState(options) {\n          var removedItemKeys = options.removedItemKeys || [];\n          var selectedItemKeys = options.selectedItemKeys || [];\n\n          this._updateSelectionStateCore(removedItemKeys, false);\n\n          this._updateSelectionStateCore(selectedItemKeys, true);\n        },\n        isRowSelected: function isRowSelected(key) {\n          var result = this.callBase.apply(this, arguments);\n          var isRecursiveSelection = this.isRecursiveSelection();\n\n          if (!result && isRecursiveSelection) {\n            if (key in this._selectionStateByKey) {\n              return this._selectionStateByKey[key];\n            }\n\n            return false;\n          }\n\n          return result;\n        },\n        getSelectedRowKeys: function getSelectedRowKeys(mode) {\n          var that = this;\n\n          if (!that._dataController) {\n            return [];\n          }\n\n          if (true === mode) {\n            _ui2.default.log(\"W0002\", \"dxTreeList\", \"getSelectedRowKeys(leavesOnly)\", \"18.1\", \"Use the 'getSelectedRowKeys(mode)' method with a string parameter instead\");\n          }\n\n          var selectedRowKeys = that.callBase.apply(that, arguments);\n\n          if (mode) {\n            if (this.isRecursiveSelection()) {\n              selectedRowKeys = this._getAllSelectedRowKeys(selectedRowKeys);\n            }\n\n            if (\"all\" !== mode) {\n              if (\"excludeRecursive\" === mode) {\n                selectedRowKeys = that._getParentSelectedRowKeys(selectedRowKeys);\n              } else {\n                if (that._isModeLeavesOnly(mode)) {\n                  selectedRowKeys = that._getLeafSelectedRowKeys(selectedRowKeys);\n                }\n              }\n            }\n          }\n\n          return selectedRowKeys;\n        },\n        getSelectedRowsData: function getSelectedRowsData(mode) {\n          var that = this;\n          var dataController = that._dataController;\n          var selectedKeys = this.getSelectedRowKeys(mode) || [];\n          var selectedRowsData = [];\n          selectedKeys.forEach(function (key) {\n            var node = dataController.getNodeByKey(key);\n            node && selectedRowsData.push(node.data);\n          });\n          return selectedRowsData;\n        },\n        refresh: function refresh() {\n          this._selectionStateByKey = {};\n          return this.callBase.apply(this, arguments);\n        }\n      }\n    },\n    views: {\n      columnHeadersView: {\n        _processTemplate: function _processTemplate(template, options) {\n          var that = this;\n          var resultTemplate;\n          var renderingTemplate = this.callBase(template, options);\n\n          var firstDataColumnIndex = that._columnsController.getFirstDataColumnIndex();\n\n          if (renderingTemplate && \"header\" === options.rowType && options.column.index === firstDataColumnIndex) {\n            resultTemplate = {\n              render: function render(options) {\n                if (\"multiple\" === that.option(\"selection.mode\")) {\n                  that.renderSelectAll(options.container, options.model);\n                }\n\n                renderingTemplate.render(options);\n              }\n            };\n          } else {\n            resultTemplate = renderingTemplate;\n          }\n\n          return resultTemplate;\n        },\n        renderSelectAll: function renderSelectAll($cell, options) {\n          $cell.addClass(TREELIST_SELECT_ALL_CLASS);\n\n          this._renderSelectAllCheckBox($cell);\n        },\n        _isSortableElement: function _isSortableElement($target) {\n          return this.callBase($target) && !$target.closest(\".\" + SELECT_CHECKBOX_CLASS).length;\n        }\n      },\n      rowsView: {\n        _renderIcons: function _renderIcons($iconContainer, options) {\n          this.callBase.apply(this, arguments);\n\n          if (\"multiple\" === this.option(\"selection.mode\")) {\n            this.getController(\"selection\").renderSelectCheckBoxContainer($iconContainer, options);\n          }\n\n          return $iconContainer;\n        },\n        _rowClick: function _rowClick(e) {\n          var $targetElement = (0, _renderer2.default)(e.event.target);\n\n          if (this.isExpandIcon($targetElement)) {\n            this.callBase.apply(this, arguments);\n          } else {\n            originalRowClick.apply(this, arguments);\n          }\n        }\n      }\n    }\n  }\n}));","map":null,"metadata":{},"sourceType":"script"}