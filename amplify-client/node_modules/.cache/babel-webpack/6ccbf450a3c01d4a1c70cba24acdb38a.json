{"ast":null,"code":"/**\r\n * DevExtreme (ui/pivot_grid/ui.pivot_grid.field_chooser_base.js)\r\n * Version: 19.2.6\r\n * Build date: Thu Jan 30 2020\r\n *\r\n * Copyright (c) 2012 - 2020 Developer Express Inc. ALL RIGHTS RESERVED\r\n * Read about DevExtreme licensing here: https://js.devexpress.com/Licensing/\r\n */\n\"use strict\";\n\nvar _renderer = require(\"../../core/renderer\");\n\nvar _renderer2 = _interopRequireDefault(_renderer);\n\nvar _events_engine = require(\"../../events/core/events_engine\");\n\nvar _events_engine2 = _interopRequireDefault(_events_engine);\n\nvar _array_store = require(\"../../data/array_store\");\n\nvar _array_store2 = _interopRequireDefault(_array_store);\n\nvar _click = require(\"../../events/click\");\n\nvar _click2 = _interopRequireDefault(_click);\n\nvar _common = require(\"../../core/utils/common\");\n\nvar _type = require(\"../../core/utils/type\");\n\nvar _array = require(\"../../core/utils/array\");\n\nvar _extend = require(\"../../core/utils/extend\");\n\nvar _iterator = require(\"../../core/utils/iterator\");\n\nvar _message = require(\"../../localization/message\");\n\nvar _component_registrator = require(\"../../core/component_registrator\");\n\nvar _component_registrator2 = _interopRequireDefault(_component_registrator);\n\nvar _ui = require(\"../widget/ui.widget\");\n\nvar _ui2 = _interopRequireDefault(_ui);\n\nvar _uiGrid_core = require(\"../grid_core/ui.grid_core.header_filter_core\");\n\nvar _uiGrid_core2 = _interopRequireDefault(_uiGrid_core);\n\nvar _uiGrid_core3 = require(\"../grid_core/ui.grid_core.column_state_mixin\");\n\nvar _uiGrid_core4 = _interopRequireDefault(_uiGrid_core3);\n\nvar _uiGrid_core5 = require(\"../grid_core/ui.grid_core.sorting_mixin\");\n\nvar _uiGrid_core6 = _interopRequireDefault(_uiGrid_core5);\n\nvar _uiPivot_grid = require(\"./ui.pivot_grid.utils\");\n\nvar _ui3 = require(\"./ui.sortable\");\n\nvar _ui4 = _interopRequireDefault(_ui3);\n\nvar _deferred = require(\"../../core/utils/deferred\");\n\nfunction _interopRequireDefault(obj) {\n  return obj && obj.__esModule ? obj : {\n    \"default\": obj\n  };\n}\n\nvar IE_FIELD_WIDTH_CORRECTION = 1;\nvar DIV = \"<div>\";\n\nvar HeaderFilterView = _uiGrid_core2.default.HeaderFilterView.inherit({\n  _getSearchExpr: function _getSearchExpr(options) {\n    options.useDefaultSearchExpr = true;\n    return this.callBase(options);\n  }\n});\n\nvar processItems = function processItems(groupItems, field) {\n  var filterValues = [];\n  var isTree = !!field.groupName;\n  var isExcludeFilterType = \"exclude\" === field.filterType;\n\n  if (field.filterValues) {\n    (0, _iterator.each)(field.filterValues, function (_, filterValue) {\n      filterValues.push(Array.isArray(filterValue) ? filterValue.join(\"/\") : filterValue && filterValue.valueOf());\n    });\n  }\n\n  (0, _uiPivot_grid.foreachTree)(groupItems, function (items) {\n    var item = items[0];\n    var path = (0, _uiPivot_grid.createPath)(items);\n    var preparedFilterValueByText = isTree ? (0, _iterator.map)(items, function (item) {\n      return item.text;\n    }).reverse().join(\"/\") : item.text;\n    item.value = isTree ? path.slice(0) : item.key || item.value;\n    var preparedFilterValue = isTree ? path.join(\"/\") : item.value && item.value.valueOf();\n\n    if (item.children) {\n      item.items = item.children;\n      item.children = null;\n    }\n\n    (0, _uiGrid_core.updateHeaderFilterItemSelectionState)(item, item.key && (0, _array.inArray)(preparedFilterValueByText, filterValues) > -1 || (0, _array.inArray)(preparedFilterValue, filterValues) > -1, isExcludeFilterType);\n  });\n};\n\nfunction getMainGroupField(dataSource, sourceField) {\n  var field = sourceField;\n\n  if ((0, _type.isDefined)(sourceField.groupIndex)) {\n    field = dataSource.getAreaFields(sourceField.area, true)[sourceField.areaIndex];\n  }\n\n  return field;\n}\n\nfunction getStringState(state) {\n  state = state || {};\n  return JSON.stringify([state.fields, state.columnExpandedPaths, state.rowExpandedPaths]);\n}\n\nvar FieldChooserBase = _ui2.default.inherit(_uiGrid_core4.default).inherit(_uiGrid_core6.default).inherit(_uiGrid_core.headerFilterMixin).inherit({\n  _getDefaultOptions: function _getDefaultOptions() {\n    return (0, _extend.extend)(this.callBase(), {\n      allowFieldDragging: true,\n      applyChangesMode: \"instantly\",\n      state: null,\n      headerFilter: {\n        width: 252,\n        height: 325,\n        searchTimeout: 500,\n        texts: {\n          emptyValue: (0, _message.format)(\"dxDataGrid-headerFilterEmptyValue\"),\n          ok: (0, _message.format)(\"dxDataGrid-headerFilterOK\"),\n          cancel: (0, _message.format)(\"dxDataGrid-headerFilterCancel\")\n        }\n      }\n    });\n  },\n  _init: function _init() {\n    this.callBase();\n    this._headerFilterView = new HeaderFilterView(this);\n\n    this._refreshDataSource();\n\n    this.subscribeToEvents();\n  },\n  _refreshDataSource: function _refreshDataSource() {\n    var dataSource = this.option(\"dataSource\");\n\n    if (dataSource && dataSource.fields && dataSource.load) {\n      this._dataSource = dataSource;\n    }\n  },\n  _optionChanged: function _optionChanged(args) {\n    switch (args.name) {\n      case \"dataSource\":\n        this._refreshDataSource();\n\n        break;\n\n      case \"applyChangesMode\":\n        break;\n\n      case \"state\":\n        if (this._skipStateChange || !this._dataSource) {\n          break;\n        }\n\n        if (\"instantly\" === this.option(\"applyChangesMode\") && getStringState(this._dataSource.state()) !== getStringState(args.value)) {\n          this._dataSource.state(args.value);\n        } else {\n          this._clean(true);\n\n          this._renderComponent();\n        }\n\n        break;\n\n      case \"headerFilter\":\n      case \"allowFieldDragging\":\n        this._invalidate();\n\n        break;\n\n      default:\n        this.callBase(args);\n    }\n  },\n  renderField: function renderField(field, showColumnLines) {\n    var that = this;\n    var $fieldContent = (0, _renderer2.default)(DIV).addClass(\"dx-area-field-content\").text(field.caption || field.dataField);\n    var $fieldElement = (0, _renderer2.default)(DIV).addClass(\"dx-area-field\").addClass(\"dx-area-box\").data(\"field\", field).append($fieldContent);\n    var mainGroupField = getMainGroupField(that._dataSource, field);\n\n    if (\"data\" !== field.area) {\n      if (field.allowSorting) {\n        that._applyColumnState({\n          name: \"sort\",\n          rootElement: $fieldElement,\n          column: {\n            alignment: that.option(\"rtlEnabled\") ? \"right\" : \"left\",\n            sortOrder: \"desc\" === field.sortOrder ? \"desc\" : \"asc\"\n          },\n          showColumnLines: showColumnLines\n        });\n      }\n\n      that._applyColumnState({\n        name: \"headerFilter\",\n        rootElement: $fieldElement,\n        column: {\n          alignment: that.option(\"rtlEnabled\") ? \"right\" : \"left\",\n          filterValues: mainGroupField.filterValues,\n          allowFiltering: mainGroupField.allowFiltering && !field.groupIndex\n        },\n        showColumnLines: showColumnLines\n      });\n    }\n\n    if (field.groupName) {\n      $fieldElement.attr(\"item-group\", field.groupName);\n    }\n\n    return $fieldElement;\n  },\n  _clean: function _clean() {},\n  _render: function _render() {\n    this.callBase();\n\n    this._headerFilterView.render(this.$element());\n  },\n  renderSortable: function renderSortable() {\n    var that = this;\n\n    that._createComponent(that.$element(), _ui4.default, (0, _extend.extend)({\n      allowDragging: that.option(\"allowFieldDragging\"),\n      itemSelector: \".dx-area-field\",\n      itemContainerSelector: \".dx-area-field-container\",\n      groupSelector: \".dx-area-fields\",\n      groupFilter: function groupFilter() {\n        var dataSource = that._dataSource;\n        var $sortable = (0, _renderer2.default)(this).closest(\".dx-sortable-old\");\n        var pivotGrid = $sortable.data(\"dxPivotGrid\");\n        var pivotGridFieldChooser = $sortable.data(\"dxPivotGridFieldChooser\");\n\n        if (pivotGrid) {\n          return pivotGrid.getDataSource() === dataSource;\n        }\n\n        if (pivotGridFieldChooser) {\n          return pivotGridFieldChooser.option(\"dataSource\") === dataSource;\n        }\n\n        return false;\n      },\n      itemRender: function itemRender($sourceItem, target) {\n        var $item;\n\n        if ($sourceItem.hasClass(\"dx-area-box\")) {\n          $item = $sourceItem.clone();\n\n          if (\"drag\" === target) {\n            (0, _iterator.each)($sourceItem, function (index, sourceItem) {\n              $item.eq(index).css(\"width\", parseInt((0, _renderer2.default)(sourceItem).outerWidth(), 10) + IE_FIELD_WIDTH_CORRECTION);\n            });\n          }\n        } else {\n          $item = (0, _renderer2.default)(DIV).addClass(\"dx-area-field\").addClass(\"dx-area-box\").text($sourceItem.text());\n        }\n\n        if (\"drag\" === target) {\n          var wrapperContainer = (0, _renderer2.default)(DIV);\n          (0, _iterator.each)($item, function (_, item) {\n            var wrapper = (0, _renderer2.default)(\"<div>\").addClass(\"dx-pivotgrid-fields-container\").addClass(\"dx-widget\").append((0, _renderer2.default)(item));\n            wrapperContainer.append(wrapper);\n          });\n          return wrapperContainer.children();\n        }\n\n        return $item;\n      },\n      onDragging: function onDragging(e) {\n        var field = e.sourceElement.data(\"field\");\n        var targetGroup = e.targetGroup;\n        e.cancel = false;\n\n        if (true === field.isMeasure) {\n          if (\"column\" === targetGroup || \"row\" === targetGroup || \"filter\" === targetGroup) {\n            e.cancel = true;\n          }\n        } else {\n          if (false === field.isMeasure && \"data\" === targetGroup) {\n            e.cancel = true;\n          }\n        }\n      },\n      useIndicator: true,\n      onChanged: function onChanged(e) {\n        var dataSource = that._dataSource;\n        var field = e.sourceElement.data(\"field\");\n        e.removeSourceElement = !!e.sourceGroup;\n\n        that._adjustSortableOnChangedArgs(e);\n\n        if (field) {\n          that._applyChanges([getMainGroupField(dataSource, field)], {\n            area: e.targetGroup,\n            areaIndex: e.targetIndex\n          });\n        }\n      }\n    }, that._getSortableOptions()));\n  },\n  _processDemandState: function _processDemandState(func) {\n    var that = this;\n    var isInstantlyMode = \"instantly\" === that.option(\"applyChangesMode\");\n    var dataSource = that._dataSource;\n\n    if (isInstantlyMode) {\n      func(dataSource, isInstantlyMode);\n    } else {\n      var currentState = dataSource.state();\n      var pivotGridState = that.option(\"state\");\n\n      if (pivotGridState) {\n        dataSource.state(pivotGridState, true);\n      }\n\n      func(dataSource, isInstantlyMode);\n      dataSource.state(currentState, true);\n    }\n  },\n  _applyChanges: function _applyChanges(fields, props) {\n    var that = this;\n\n    that._processDemandState(function (dataSource, isInstantlyMode) {\n      fields.forEach(function (_ref) {\n        var index = _ref.index;\n        dataSource.field(index, props);\n      });\n\n      if (isInstantlyMode) {\n        dataSource.load();\n      } else {\n        that._changedHandler();\n      }\n    });\n  },\n  _adjustSortableOnChangedArgs: function _adjustSortableOnChangedArgs(e) {\n    e.removeSourceElement = false;\n    e.removeTargetElement = true;\n    e.removeSourceClass = false;\n  },\n  _getSortableOptions: function _getSortableOptions() {\n    return {\n      direction: \"auto\"\n    };\n  },\n  subscribeToEvents: function subscribeToEvents(element) {\n    var that = this;\n\n    var func = function func(e) {\n      var field = (0, _renderer2.default)(e.currentTarget).data(\"field\");\n      var mainGroupField = (0, _extend.extend)(true, {}, getMainGroupField(that._dataSource, field));\n      var isHeaderFilter = (0, _renderer2.default)(e.target).hasClass(\"dx-header-filter\");\n      var dataSource = that._dataSource;\n      var type = mainGroupField.groupName ? \"tree\" : \"list\";\n      var paginate = dataSource.paginate() && \"list\" === type;\n\n      if (isHeaderFilter) {\n        that._headerFilterView.showHeaderFilterMenu((0, _renderer2.default)(e.currentTarget), (0, _extend.extend)(mainGroupField, {\n          type: type,\n          encodeHtml: that.option(\"encodeHtml\"),\n          dataSource: {\n            useDefaultSearch: !paginate,\n            load: function load(options) {\n              var userData = options.userData;\n\n              if (userData.store) {\n                return userData.store.load(options);\n              } else {\n                var d = new _deferred.Deferred();\n                dataSource.getFieldValues(mainGroupField.index, that.option(\"headerFilter.showRelevantValues\"), paginate ? options : void 0).done(function (data) {\n                  if (paginate) {\n                    d.resolve(data);\n                  } else {\n                    userData.store = new _array_store2.default(data);\n                    userData.store.load(options).done(d.resolve).fail(d.reject);\n                  }\n                }).fail(d.reject);\n                return d;\n              }\n            },\n            postProcess: function postProcess(data) {\n              processItems(data, mainGroupField);\n              return data;\n            }\n          },\n          apply: function apply() {\n            that._applyChanges([mainGroupField], {\n              filterValues: this.filterValues,\n              filterType: this.filterType\n            });\n          }\n        }));\n      } else {\n        if (field.allowSorting && \"data\" !== field.area) {\n          that._applyChanges([field], {\n            sortOrder: \"desc\" === field.sortOrder ? \"asc\" : \"desc\"\n          });\n        }\n      }\n    };\n\n    if (element) {\n      _events_engine2.default.on(element, _click2.default.name, \".dx-area-field.dx-area-box\", func);\n\n      return;\n    }\n\n    _events_engine2.default.on(that.$element(), _click2.default.name, \".dx-area-field.dx-area-box\", func);\n  },\n  _initTemplates: _common.noop,\n  addWidgetPrefix: function addWidgetPrefix(className) {\n    return \"dx-pivotgrid-\" + className;\n  }\n});\n\n(0, _component_registrator2.default)(\"dxPivotGridFieldChooserBase\", FieldChooserBase);\nmodule.exports = FieldChooserBase;","map":null,"metadata":{},"sourceType":"script"}