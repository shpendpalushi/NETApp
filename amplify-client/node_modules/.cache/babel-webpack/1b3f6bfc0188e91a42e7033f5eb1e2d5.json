{"ast":null,"code":"/**\r\n * DevExtreme (ui/grid_core/ui.grid_core.focus.js)\r\n * Version: 19.2.6\r\n * Build date: Thu Jan 30 2020\r\n *\r\n * Copyright (c) 2012 - 2020 Developer Express Inc. ALL RIGHTS RESERVED\r\n * Read about DevExtreme licensing here: https://js.devexpress.com/Licensing/\r\n */\n\"use strict\";\n\nvar _renderer = require(\"../../core/renderer\");\n\nvar _renderer2 = _interopRequireDefault(_renderer);\n\nvar _uiGrid_core = require(\"./ui.grid_core.modules\");\n\nvar _uiGrid_core2 = _interopRequireDefault(_uiGrid_core);\n\nvar _iterator = require(\"../../core/utils/iterator\");\n\nvar _uiGrid_core3 = require(\"./ui.grid_core.utils\");\n\nvar _common = require(\"../../core/utils/common\");\n\nvar _type = require(\"../../core/utils/type\");\n\nvar _deferred = require(\"../../core/utils/deferred\");\n\nfunction _interopRequireDefault(obj) {\n  return obj && obj.__esModule ? obj : {\n    \"default\": obj\n  };\n}\n\nvar ROW_FOCUSED_CLASS = \"dx-row-focused\";\nvar FOCUSED_ROW_SELECTOR = \".dx-row.\" + ROW_FOCUSED_CLASS;\nvar TABLE_POSTFIX_CLASS = \"table\";\nvar CELL_FOCUS_DISABLED_CLASS = \"dx-cell-focus-disabled\";\nexports.FocusController = _uiGrid_core2.default.ViewController.inherit(function () {\n  return {\n    init: function init() {\n      this._dataController = this.getController(\"data\");\n      this._keyboardController = this.getController(\"keyboardNavigation\");\n      this.component._optionsByReference.focusedRowKey = true;\n    },\n    optionChanged: function optionChanged(args) {\n      if (\"focusedRowIndex\" === args.name) {\n        this._focusRowByIndex(args.value);\n\n        args.handled = true;\n      } else {\n        if (\"focusedRowKey\" === args.name) {\n          this._focusRowByKey(args.value);\n\n          args.handled = true;\n        } else {\n          if (\"focusedColumnIndex\" === args.name) {\n            args.handled = true;\n          } else {\n            if (\"focusedRowEnabled\" === args.name) {\n              args.handled = true;\n            } else {\n              if (\"autoNavigateToFocusedRow\" === args.name) {\n                args.handled = true;\n              } else {\n                this.callBase(args);\n              }\n            }\n          }\n        }\n      }\n    },\n    _focusRowByIndex: function _focusRowByIndex(index) {\n      if (!this.option(\"focusedRowEnabled\")) {\n        return;\n      }\n\n      index = void 0 !== index ? index : this.option(\"focusedRowIndex\");\n\n      if (index < 0) {\n        if (this.option(\"autoNavigateToFocusedRow\")) {\n          this._resetFocusedRow();\n        }\n      } else {\n        this._focusRowByIndexCore(index);\n      }\n    },\n    _focusRowByIndexCore: function _focusRowByIndexCore(index) {\n      var _this = this;\n\n      var dataController = this.getController(\"data\");\n      var pageSize = dataController.pageSize();\n\n      var setKeyByIndex = function setKeyByIndex() {\n        if (_this._isValidFocusedRowIndex(index)) {\n          var rowIndex = Math.min(index - dataController.getRowIndexOffset(), dataController.items().length - 1);\n          var focusedRowKey = dataController.getKeyByRowIndex(rowIndex);\n\n          if (void 0 !== focusedRowKey && !_this.isRowFocused(focusedRowKey)) {\n            _this.option(\"focusedRowKey\", focusedRowKey);\n          }\n        }\n      };\n\n      if (pageSize >= 0) {\n        if (!this._isLocalRowIndex(index)) {\n          var pageIndex = Math.floor(index / dataController.pageSize());\n          (0, _deferred.when)(dataController.pageIndex(pageIndex), dataController.waitReady()).done(function () {\n            setKeyByIndex();\n          });\n        } else {\n          setKeyByIndex();\n        }\n      }\n    },\n    _isLocalRowIndex: function _isLocalRowIndex(index) {\n      var dataController = this.getController(\"data\");\n\n      var isVirtualScrolling = this.getController(\"keyboardNavigation\")._isVirtualScrolling();\n\n      if (isVirtualScrolling) {\n        var pageIndex = Math.floor(index / dataController.pageSize());\n        var virtualItems = dataController.virtualItemsCount();\n        var virtualItemsBegin = virtualItems ? virtualItems.begin : -1;\n        var visibleRowsCount = dataController.getVisibleRows().length + dataController.getRowIndexOffset();\n        var visiblePagesCount = Math.ceil(visibleRowsCount / dataController.pageSize());\n        return virtualItemsBegin <= index && visiblePagesCount > pageIndex;\n      }\n\n      return true;\n    },\n    _setFocusedRowKeyByIndex: function _setFocusedRowKeyByIndex(index) {\n      var dataController = this.getController(\"data\");\n\n      if (this._isValidFocusedRowIndex(index)) {\n        var rowIndex = Math.min(index - dataController.getRowIndexOffset(), dataController.items().length - 1);\n        var focusedRowKey = dataController.getKeyByRowIndex(rowIndex);\n\n        if (void 0 !== focusedRowKey && !this.isRowFocused(focusedRowKey)) {\n          this.option(\"focusedRowKey\", focusedRowKey);\n        }\n      }\n    },\n    _focusRowByKey: function _focusRowByKey(key) {\n      if (void 0 === key) {\n        this._resetFocusedRow();\n      } else {\n        this._navigateToRow(key, true);\n      }\n    },\n    _resetFocusedRow: function _resetFocusedRow() {\n      if (void 0 === this.option(\"focusedRowKey\") && this.option(\"focusedRowIndex\") < 0) {\n        return;\n      }\n\n      this.option(\"focusedRowKey\", void 0);\n      this.getController(\"keyboardNavigation\").setFocusedRowIndex(-1);\n      this.option(\"focusedRowIndex\", -1);\n      this.getController(\"data\").updateItems({\n        changeType: \"updateFocusedRow\",\n        focusedRowKey: void 0\n      });\n    },\n    _isValidFocusedRowIndex: function _isValidFocusedRowIndex(rowIndex) {\n      var dataController = this.getController(\"data\");\n      var row = dataController.getVisibleRows()[rowIndex];\n      return !row || \"data\" === row.rowType || \"group\" === row.rowType;\n    },\n    publicMethods: function publicMethods() {\n      return [\"navigateToRow\", \"isRowFocused\"];\n    },\n    navigateToRow: function navigateToRow(key) {\n      if (!this.option(\"autoNavigateToFocusedRow\")) {\n        this.option(\"focusedRowIndex\", -1);\n      }\n\n      this._navigateToRow(key);\n    },\n    _navigateToRow: function _navigateToRow(key, needFocusRow) {\n      var that = this;\n      var dataController = this.getController(\"data\");\n      var isAutoNavigate = that.option(\"autoNavigateToFocusedRow\");\n      var d = new _deferred.Deferred();\n\n      if (void 0 === key || !dataController.dataSource()) {\n        return d.reject().promise();\n      }\n\n      var rowIndexByKey = that.getFocusedRowIndexByKey(key);\n      var isPaginate = dataController.getDataSource().paginate();\n\n      if (!isAutoNavigate && needFocusRow || !isPaginate || rowIndexByKey >= 0) {\n        that._navigateTo(key, d, needFocusRow);\n      } else {\n        dataController.getPageIndexByKey(key).done(function (pageIndex) {\n          if (pageIndex < 0) {\n            d.resolve(-1);\n            return;\n          }\n\n          if (pageIndex === dataController.pageIndex()) {\n            dataController.reload().done(function () {\n              if (that.isRowFocused(key)) {\n                d.resolve(that.getFocusedRowIndexByKey(key));\n              } else {\n                that._navigateTo(key, d, needFocusRow);\n              }\n            }).fail(d.reject);\n          } else {\n            dataController.pageIndex(pageIndex).done(function () {\n              that._navigateTo(key, d, needFocusRow);\n            }).fail(d.reject);\n          }\n        }).fail(d.reject);\n      }\n\n      return d.promise();\n    },\n    _navigateTo: function _navigateTo(key, deferred, needFocusRow) {\n      var visibleRowIndex = this.getController(\"data\").getRowIndexByKey(key);\n      var isVirtualRowRenderingMode = \"virtual\" === this.option(\"scrolling.rowRenderingMode\");\n      var isAutoNavigate = this.option(\"autoNavigateToFocusedRow\");\n\n      if (isAutoNavigate && isVirtualRowRenderingMode && visibleRowIndex < 0) {\n        this._navigateToVirtualRow(key, deferred, needFocusRow);\n      } else {\n        this._navigateToVisibleRow(key, deferred, needFocusRow);\n      }\n    },\n    _navigateToVisibleRow: function _navigateToVisibleRow(key, deferred, needFocusRow) {\n      if (needFocusRow) {\n        this._triggerUpdateFocusedRow(key, deferred);\n      } else {\n        this.getView(\"rowsView\").scrollToRowElement(key);\n      }\n    },\n    _navigateToVirtualRow: function _navigateToVirtualRow(key, deferred, needFocusRow) {\n      var that = this;\n      var dataController = this.getController(\"data\");\n      var rowsScrollController = dataController._rowsScrollController;\n      var rowIndex = (0, _uiGrid_core3.getIndexByKey)(key, dataController.items(true));\n      var scrollable = that.getView(\"rowsView\").getScrollable();\n\n      if (rowsScrollController && scrollable && rowIndex >= 0) {\n        var focusedRowIndex = rowIndex + dataController.getRowIndexOffset() - dataController.getRowIndexDelta();\n        var offset = rowsScrollController.getItemOffset(focusedRowIndex);\n\n        if (needFocusRow) {\n          var triggerUpdateFocusedRow = function triggerUpdateFocusedRow() {\n            that.component.off(\"contentReady\", triggerUpdateFocusedRow);\n\n            that._triggerUpdateFocusedRow(key, deferred);\n          };\n\n          that.component.on(\"contentReady\", triggerUpdateFocusedRow);\n        }\n\n        scrollable.scrollTo({\n          y: offset\n        });\n      }\n    },\n    _triggerUpdateFocusedRow: function _triggerUpdateFocusedRow(key, deferred) {\n      var dataController = this.getController(\"data\");\n      var focusedRowIndex = this.getFocusedRowIndexByKey(key);\n\n      if (this._isValidFocusedRowIndex(focusedRowIndex)) {\n        this.getController(\"keyboardNavigation\").setFocusedRowIndex(focusedRowIndex);\n\n        if (this.option(\"focusedRowEnabled\")) {\n          dataController.updateItems({\n            changeType: \"updateFocusedRow\",\n            focusedRowKey: key\n          });\n        } else {\n          this.getView(\"rowsView\").scrollToRowElement(key);\n        }\n\n        deferred && deferred.resolve(focusedRowIndex);\n      } else {\n        deferred && deferred.resolve(-1);\n      }\n    },\n    getFocusedRowIndexByKey: function getFocusedRowIndexByKey(key) {\n      var dataController = this.getController(\"data\");\n      var rowIndex = dataController.getRowIndexByKey(key);\n      return rowIndex >= 0 ? rowIndex + dataController.getRowIndexOffset() : -1;\n    },\n    _focusRowByKeyOrIndex: function _focusRowByKeyOrIndex() {\n      var _this2 = this;\n\n      var focusedRowKey = this.option(\"focusedRowKey\");\n      var currentFocusedRowIndex = this.option(\"focusedRowIndex\");\n      var keyboardController = this.getController(\"keyboardNavigation\");\n      var dataController = this.getController(\"data\");\n\n      if (void 0 !== focusedRowKey) {\n        var visibleRowIndex = dataController.getRowIndexByKey(focusedRowKey);\n\n        if (visibleRowIndex >= 0) {\n          if (keyboardController._isVirtualScrolling()) {\n            currentFocusedRowIndex = visibleRowIndex + dataController.getRowIndexOffset();\n          }\n\n          keyboardController.setFocusedRowIndex(currentFocusedRowIndex);\n\n          this._triggerUpdateFocusedRow(focusedRowKey);\n        } else {\n          this._navigateToRow(focusedRowKey, true).done(function (focusedRowIndex) {\n            if (currentFocusedRowIndex >= 0 && focusedRowIndex < 0) {\n              _this2._focusRowByIndex();\n            }\n          });\n        }\n      } else {\n        if (currentFocusedRowIndex >= 0) {\n          this.getController(\"focus\")._focusRowByIndex(currentFocusedRowIndex);\n        }\n      }\n    },\n    isRowFocused: function isRowFocused(key) {\n      var focusedRowKey = this.option(\"focusedRowKey\");\n\n      if (void 0 !== focusedRowKey) {\n        return (0, _common.equalByValue)(key, this.option(\"focusedRowKey\"));\n      }\n    },\n    updateFocusedRow: function updateFocusedRow(change) {\n      var that = this;\n\n      var focusedRowIndex = that._dataController.getRowIndexByKey(change.focusedRowKey);\n\n      var rowsView = that.getView(\"rowsView\");\n      var $focusedRow;\n      var $tableElement;\n      (0, _iterator.each)(rowsView.getTableElements(), function (index, element) {\n        $tableElement = (0, _renderer2.default)(element);\n\n        that._clearPreviousFocusedRow($tableElement, focusedRowIndex);\n\n        var isMainTable = 0 === index;\n        $focusedRow = that._prepareFocusedRow({\n          changedItem: change.items[focusedRowIndex],\n          $tableElement: $tableElement,\n          focusedRowIndex: focusedRowIndex,\n          isMainTable: isMainTable\n        });\n\n        if (isMainTable) {\n          that.getController(\"keyboardNavigation\")._fireFocusedRowChanged($focusedRow);\n        }\n      });\n    },\n    _clearPreviousFocusedRow: function _clearPreviousFocusedRow($tableElement, focusedRowIndex) {\n      var _this3 = this;\n\n      var isNotMasterDetailFocusedRow = function isNotMasterDetailFocusedRow(_, focusedRow) {\n        var $focusedRowTable = (0, _renderer2.default)(focusedRow).closest(\".\".concat(_this3.addWidgetPrefix(TABLE_POSTFIX_CLASS)));\n        return $tableElement.is($focusedRowTable);\n      };\n\n      var $prevRowFocusedElement = $tableElement.find(FOCUSED_ROW_SELECTOR).filter(isNotMasterDetailFocusedRow);\n      $prevRowFocusedElement.removeClass(ROW_FOCUSED_CLASS).removeClass(CELL_FOCUS_DISABLED_CLASS).removeAttr(\"tabindex\");\n      $prevRowFocusedElement.children(\"td\").removeAttr(\"tabindex\");\n\n      if (0 !== focusedRowIndex) {\n        var $firstRow = (0, _renderer2.default)(this.getView(\"rowsView\").getRowElement(0));\n        $firstRow.removeClass(CELL_FOCUS_DISABLED_CLASS).removeAttr(\"tabIndex\");\n      }\n    },\n    _prepareFocusedRow: function _prepareFocusedRow(options) {\n      var $row;\n      var changedItem = options.changedItem;\n\n      if (changedItem && (\"data\" === changedItem.rowType || \"group\" === changedItem.rowType)) {\n        var focusedRowIndex = options.focusedRowIndex;\n        var $tableElement = options.$tableElement;\n        var isMainTable = options.isMainTable;\n        var tabIndex = this.option(\"tabindex\") || 0;\n        var rowsView = this.getView(\"rowsView\");\n        $row = (0, _renderer2.default)(rowsView._getRowElements($tableElement).eq(focusedRowIndex));\n        $row.addClass(ROW_FOCUSED_CLASS).attr(\"tabindex\", tabIndex);\n\n        if (isMainTable) {\n          rowsView.scrollToElementVertically($row);\n        }\n      }\n\n      return $row;\n    }\n  };\n}());\nmodule.exports = {\n  defaultOptions: function defaultOptions() {\n    return {\n      focusedRowEnabled: false,\n      autoNavigateToFocusedRow: true,\n      focusedRowKey: void 0,\n      focusedRowIndex: -1,\n      focusedColumnIndex: -1\n    };\n  },\n  controllers: {\n    focus: exports.FocusController\n  },\n  extenders: {\n    controllers: {\n      keyboardNavigation: {\n        init: function init() {\n          var rowIndex = this.option(\"focusedRowIndex\");\n          var columnIndex = this.option(\"focusedColumnIndex\");\n          this.createAction(\"onFocusedRowChanging\", {\n            excludeValidators: [\"disabled\", \"readOnly\"]\n          });\n          this.createAction(\"onFocusedRowChanged\", {\n            excludeValidators: [\"disabled\", \"readOnly\"]\n          });\n          this.createAction(\"onFocusedCellChanging\", {\n            excludeValidators: [\"disabled\", \"readOnly\"]\n          });\n          this.createAction(\"onFocusedCellChanged\", {\n            excludeValidators: [\"disabled\", \"readOnly\"]\n          });\n          this.callBase();\n          this.setRowFocusType();\n          this._focusedCellPosition = {};\n\n          if ((0, _type.isDefined)(rowIndex)) {\n            this._focusedCellPosition.rowIndex = this.option(\"focusedRowIndex\");\n          }\n\n          if ((0, _type.isDefined)(columnIndex)) {\n            this._focusedCellPosition.columnIndex = this.option(\"focusedColumnIndex\");\n          }\n        },\n        setFocusedRowIndex: function setFocusedRowIndex(rowIndex) {\n          this.callBase(rowIndex);\n          var visibleRow = this.getController(\"data\").getVisibleRows()[rowIndex];\n\n          if (!visibleRow || !visibleRow.isNewRow) {\n            this.option(\"focusedRowIndex\", rowIndex);\n          }\n        },\n        setFocusedColumnIndex: function setFocusedColumnIndex(columnIndex) {\n          this.callBase(columnIndex);\n          this.option(\"focusedColumnIndex\", columnIndex);\n        },\n        _escapeKeyHandler: function _escapeKeyHandler(eventArgs, isEditing) {\n          if (isEditing || !this.option(\"focusedRowEnabled\")) {\n            this.callBase(eventArgs, isEditing);\n            return;\n          }\n\n          if (this.isCellFocusType()) {\n            this.setRowFocusType();\n\n            this._focus(this._getCellElementFromTarget(eventArgs.originalEvent.target), true);\n          }\n        },\n        _updateFocusedCellPosition: function _updateFocusedCellPosition($cell, direction) {\n          var prevRowIndex = this.option(\"focusedRowIndex\");\n          var prevColumnIndex = this.option(\"focusedColumnIndex\");\n\n          if (this.callBase($cell, direction)) {\n            this._fireFocusedCellChanged($cell, prevColumnIndex, prevRowIndex);\n          }\n        }\n      },\n      editorFactory: {\n        renderFocusOverlay: function renderFocusOverlay($element, hideBorder) {\n          var keyboardController = this.getController(\"keyboardNavigation\");\n          var focusedRowEnabled = this.option(\"focusedRowEnabled\");\n          var editingController = this.getController(\"editing\");\n\n          var isRowElement = \"row\" === keyboardController._getElementType($element);\n\n          var $cell;\n\n          if (!focusedRowEnabled || !keyboardController.isRowFocusType() || editingController.isEditing()) {\n            this.callBase($element, hideBorder);\n          } else {\n            if (focusedRowEnabled) {\n              if (isRowElement && !$element.hasClass(ROW_FOCUSED_CLASS)) {\n                $cell = keyboardController.getFirstValidCellInRow($element);\n                keyboardController.focus($cell);\n              }\n            }\n          }\n        }\n      },\n      columns: {\n        getSortDataSourceParameters: function getSortDataSourceParameters(_, sortByKey) {\n          var _this4 = this;\n\n          var result = this.callBase.apply(this, arguments);\n          var dataController = this.getController(\"data\");\n          var dataSource = dataController._dataSource;\n          var store = dataController.store();\n          var key = store && store.key();\n          var remoteOperations = dataSource && dataSource.remoteOperations() || {};\n          var isLocalOperations = Object.keys(remoteOperations).every(function (operationName) {\n            return !remoteOperations[operationName];\n          });\n\n          if (key && (this.option(\"focusedRowEnabled\") && false !== this.option(\"autoNavigateToFocusedRow\") || sortByKey)) {\n            key = Array.isArray(key) ? key : [key];\n            var notSortedKeys = key.filter(function (key) {\n              return !_this4.columnOption(key, \"sortOrder\");\n            });\n\n            if (notSortedKeys.length) {\n              result = result || [];\n\n              if (isLocalOperations) {\n                result.push({\n                  selector: dataSource.getDataIndexGetter(),\n                  desc: false\n                });\n              } else {\n                notSortedKeys.forEach(function (notSortedKey) {\n                  return result.push({\n                    selector: notSortedKey,\n                    desc: false\n                  });\n                });\n              }\n            }\n          }\n\n          return result;\n        }\n      },\n      data: {\n        _applyChange: function _applyChange(change) {\n          if (change && \"updateFocusedRow\" === change.changeType) {\n            return;\n          }\n\n          return this.callBase.apply(this, arguments);\n        },\n        _fireChanged: function _fireChanged(e) {\n          var isPartialUpdateWithDeleting;\n\n          if (this.option(\"focusedRowEnabled\") && this._dataSource) {\n            var isPartialUpdate = \"update\" === e.changeType && e.repaintChangesOnly;\n            isPartialUpdateWithDeleting = isPartialUpdate && e.changeTypes && e.changeTypes.indexOf(\"remove\") >= 0;\n\n            if (isPartialUpdateWithDeleting) {\n              this.callBase(e);\n            }\n\n            if (\"refresh\" === e.changeType && e.items.length || isPartialUpdateWithDeleting) {\n              this.processUpdateFocusedRow();\n            }\n          }\n\n          if (!isPartialUpdateWithDeleting) {\n            this.callBase(e);\n          }\n        },\n        processUpdateFocusedRow: function processUpdateFocusedRow() {\n          var prevPageIndex = this._prevPageIndex;\n          var pageIndex = this.pageIndex();\n          var prevRenderingPageIndex = this._prevRenderingPageIndex || 0;\n          var renderingPageIndex = this._rowsScrollController ? this._rowsScrollController.pageIndex() : 0;\n          var operationTypes = this._dataSource.operationTypes() || {};\n          var focusController = this.getController(\"focus\");\n          var reload = operationTypes.reload;\n          var keyboardController = this.getController(\"keyboardNavigation\");\n\n          var isVirtualScrolling = keyboardController._isVirtualScrolling();\n\n          var focusedRowKey = this.option(\"focusedRowKey\");\n          var paging = void 0 !== prevPageIndex && prevPageIndex !== pageIndex;\n          var pagingByRendering = renderingPageIndex !== prevRenderingPageIndex;\n          var isAutoNavigate = this.option(\"autoNavigateToFocusedRow\");\n          this._prevPageIndex = pageIndex;\n          this._prevRenderingPageIndex = renderingPageIndex;\n\n          if (reload && void 0 !== focusedRowKey) {\n            focusController._navigateToRow(focusedRowKey, true).done(function (focusedRowIndex) {\n              if (focusedRowIndex < 0) {\n                focusController._focusRowByIndex();\n              }\n            });\n          } else {\n            if (paging) {\n              if (isAutoNavigate) {\n                var rowIndexByKey = this.getRowIndexByKey(focusedRowKey);\n                var isValidRowIndexByKey = rowIndexByKey >= 0;\n                var focusedRowIndex = this.option(\"focusedRowIndex\");\n                var needFocusRowByIndex = focusedRowIndex >= 0 && (focusedRowIndex === rowIndexByKey || !isValidRowIndexByKey);\n\n                if (!isVirtualScrolling && needFocusRowByIndex) {\n                  focusController._focusRowByIndex();\n                }\n              } else {\n                this.option(\"focusedRowIndex\", -1);\n              }\n            } else {\n              if (!pagingByRendering) {\n                focusController._focusRowByKeyOrIndex();\n              }\n            }\n          }\n        },\n        getPageIndexByKey: function getPageIndexByKey(key) {\n          var that = this;\n          var d = new _deferred.Deferred();\n          that.getGlobalRowIndexByKey(key).done(function (globalIndex) {\n            d.resolve(globalIndex >= 0 ? Math.floor(globalIndex / that.pageSize()) : -1);\n          }).fail(d.reject);\n          return d.promise();\n        },\n        getGlobalRowIndexByKey: function getGlobalRowIndexByKey(key) {\n          if (this._dataSource.group()) {\n            return this._calculateGlobalRowIndexByGroupedData(key);\n          }\n\n          return this._calculateGlobalRowIndexByFlatData(key);\n        },\n        _calculateGlobalRowIndexByFlatData: function _calculateGlobalRowIndexByFlatData(key, groupFilter, useGroup) {\n          var that = this;\n          var deferred = new _deferred.Deferred();\n          var dataSource = that._dataSource;\n\n          var filter = that._generateFilterByKey(key);\n\n          dataSource.load({\n            filter: that._concatWithCombinedFilter(filter),\n            skip: 0,\n            take: 1\n          }).done(function (data) {\n            if (data.length > 0) {\n              filter = that._generateOperationFilterByKey(key, data[0], useGroup);\n              dataSource.load({\n                filter: that._concatWithCombinedFilter(filter, groupFilter),\n                skip: 0,\n                take: 1,\n                requireTotalCount: true\n              }).done(function (_, extra) {\n                deferred.resolve(extra.totalCount);\n              });\n            } else {\n              deferred.resolve(-1);\n            }\n          });\n          return deferred.promise();\n        },\n        _concatWithCombinedFilter: function _concatWithCombinedFilter(filter, groupFilter) {\n          var combinedFilter = this.getCombinedFilter();\n          return (0, _uiGrid_core3.combineFilters)([filter, combinedFilter, groupFilter]);\n        },\n        _generateBooleanFilter: function _generateBooleanFilter(selector, value, sortInfo) {\n          var result;\n\n          if (false === value) {\n            result = [selector, \"=\", sortInfo.desc ? true : null];\n          } else {\n            if (true === value ? !sortInfo.desc : sortInfo.desc) {\n              result = [selector, \"<>\", value];\n            }\n          }\n\n          return result;\n        },\n        _generateOperationFilterByKey: function _generateOperationFilterByKey(key, rowData, useGroup) {\n          var that = this;\n          var booleanFilter;\n          var dataSource = that._dataSource;\n\n          var filter = that._generateFilterByKey(key, \"<\");\n\n          var sort = that._columnsController.getSortDataSourceParameters(!dataSource.remoteOperations().filtering, true);\n\n          if (useGroup) {\n            var group = that._columnsController.getGroupDataSourceParameters(!dataSource.remoteOperations().filtering);\n\n            if (group) {\n              sort = sort ? group.concat(sort) : group;\n            }\n          }\n\n          if (sort) {\n            sort.slice().reverse().forEach(function (sortInfo) {\n              var selector = sortInfo.selector;\n              var getter;\n              var value;\n\n              if (\"function\" === typeof selector) {\n                getter = selector;\n              } else {\n                getter = that._columnsController.columnOption(selector, \"selector\");\n              }\n\n              value = getter ? getter(rowData) : rowData[selector];\n              filter = [[selector, \"=\", value], \"and\", filter];\n\n              if (null === value || (0, _type.isBoolean)(value)) {\n                booleanFilter = that._generateBooleanFilter(selector, value, sortInfo);\n\n                if (booleanFilter) {\n                  filter = [booleanFilter, \"or\", filter];\n                }\n              } else {\n                filter = [[selector, sortInfo.desc ? \">\" : \"<\", value], \"or\", filter];\n              }\n            });\n          }\n\n          return filter;\n        },\n        _generateFilterByKey: function _generateFilterByKey(key, operation) {\n          var dataSourceKey = this._dataSource.key();\n\n          var filter = [];\n          var keyPart;\n\n          if (!operation) {\n            operation = \"=\";\n          }\n\n          if (Array.isArray(dataSourceKey)) {\n            for (var i = 0; i < dataSourceKey.length; ++i) {\n              keyPart = key[dataSourceKey[i]];\n\n              if (keyPart) {\n                if (filter.length > 0) {\n                  filter.push(\"and\");\n                }\n\n                filter.push([dataSourceKey[i], operation, keyPart]);\n              }\n            }\n          } else {\n            filter = [dataSourceKey, operation, key];\n          }\n\n          return filter;\n        }\n      }\n    },\n    views: {\n      rowsView: {\n        _createRow: function _createRow(row) {\n          var $row = this.callBase(row);\n\n          if (this.option(\"focusedRowEnabled\") && row) {\n            if (this.getController(\"focus\").isRowFocused(row.key)) {\n              $row.addClass(ROW_FOCUSED_CLASS);\n            }\n          }\n\n          return $row;\n        },\n        _checkRowKeys: function _checkRowKeys(options) {\n          this.callBase.apply(this, arguments);\n\n          if (this.option(\"focusedRowEnabled\") && this.option(\"dataSource\")) {\n            var store = this._dataController.store();\n\n            if (store && !store.key()) {\n              this._dataController.fireError(\"E1042\", \"Row focusing\");\n            }\n          }\n        },\n        _update: function _update(change) {\n          if (\"updateFocusedRow\" === change.changeType) {\n            if (this.option(\"focusedRowEnabled\")) {\n              this.getController(\"focus\").updateFocusedRow(change);\n            }\n          } else {\n            this.callBase(change);\n          }\n        },\n        updateFocusElementTabIndex: function updateFocusElementTabIndex($cellElements) {\n          if (this.option(\"focusedRowEnabled\")) {\n            this._setFocusedRowElementTabIndex();\n          } else {\n            this.callBase($cellElements);\n          }\n        },\n        _setFocusedRowElementTabIndex: function _setFocusedRowElementTabIndex() {\n          var that = this;\n          var focusedRowKey = that.option(\"focusedRowKey\");\n          var tabIndex = that.option(\"tabIndex\") || 0;\n\n          var rowIndex = that._dataController.getRowIndexByKey(focusedRowKey);\n\n          var columnIndex = that.option(\"focusedColumnIndex\");\n\n          var $row = that._findRowElementForTabIndex();\n\n          that._scrollToFocusOnResize = that._scrollToFocusOnResize || function () {\n            that.scrollToElementVertically(that._findRowElementForTabIndex());\n            that.resizeCompleted.remove(that._scrollToFocusOnResize);\n          };\n\n          $row.attr(\"tabIndex\", tabIndex);\n\n          if (rowIndex >= 0) {\n            if (columnIndex < 0) {\n              columnIndex = 0;\n            }\n\n            rowIndex += that.getController(\"data\").getRowIndexOffset();\n            that.getController(\"keyboardNavigation\").setFocusedCellPosition(rowIndex, columnIndex);\n\n            var dataSource = that.component.getController(\"data\")._dataSource;\n\n            var operationTypes = dataSource && dataSource.operationTypes();\n\n            if (operationTypes && !operationTypes.paging) {\n              that.resizeCompleted.remove(that._scrollToFocusOnResize);\n              that.resizeCompleted.add(that._scrollToFocusOnResize);\n            }\n          }\n        },\n        _findRowElementForTabIndex: function _findRowElementForTabIndex() {\n          var focusedRowKey = this.option(\"focusedRowKey\");\n\n          var rowIndex = this._dataController.getRowIndexByKey(focusedRowKey);\n\n          return (0, _renderer2.default)(this.getRowElement(rowIndex >= 0 ? rowIndex : 0));\n        },\n        scrollToRowElement: function scrollToRowElement(key) {\n          var rowIndex = this.getController(\"data\").getRowIndexByKey(key);\n          var $row = (0, _renderer2.default)(this.getRow(rowIndex));\n          this.scrollToElementVertically($row);\n        },\n        scrollToElementVertically: function scrollToElementVertically($row) {\n          var scrollable = this.getScrollable();\n\n          if (scrollable) {\n            var position = scrollable.getScrollElementPosition($row, \"vertical\");\n            scrollable.scrollTo({\n              top: position\n            });\n          }\n        }\n      }\n    }\n  }\n};","map":null,"metadata":{},"sourceType":"script"}