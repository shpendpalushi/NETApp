{"ast":null,"code":"/**\r\n * DevExtreme (ui/html_editor/ui.html_editor.js)\r\n * Version: 19.2.6\r\n * Build date: Thu Jan 30 2020\r\n *\r\n * Copyright (c) 2012 - 2020 Developer Express Inc. ALL RIGHTS RESERVED\r\n * Read about DevExtreme licensing here: https://js.devexpress.com/Licensing/\r\n */\n\"use strict\";\n\nvar _renderer = require(\"../../core/renderer\");\n\nvar _renderer2 = _interopRequireDefault(_renderer);\n\nvar _extend = require(\"../../core/utils/extend\");\n\nvar _type = require(\"../../core/utils/type\");\n\nvar _dom = require(\"../../core/utils/dom\");\n\nvar _common = require(\"../../core/utils/common\");\n\nvar _component_registrator = require(\"../../core/component_registrator\");\n\nvar _component_registrator2 = _interopRequireDefault(_component_registrator);\n\nvar _empty_template = require(\"../../core/templates/empty_template\");\n\nvar _editor = require(\"../editor/editor\");\n\nvar _editor2 = _interopRequireDefault(_editor);\n\nvar _ui = require(\"../widget/ui.errors\");\n\nvar _ui2 = _interopRequireDefault(_ui);\n\nvar _callbacks = require(\"../../core/utils/callbacks\");\n\nvar _callbacks2 = _interopRequireDefault(_callbacks);\n\nvar _deferred = require(\"../../core/utils/deferred\");\n\nvar _events_engine = require(\"../../events/core/events_engine\");\n\nvar _events_engine2 = _interopRequireDefault(_events_engine);\n\nvar _utils = require(\"../../events/utils\");\n\nvar _uiEventsEmitterGesture = require(\"../scroll_view/ui.events.emitter.gesture.scroll\");\n\nvar _uiEventsEmitterGesture2 = _interopRequireDefault(_uiEventsEmitterGesture);\n\nvar _utils2 = require(\"../text_box/utils.scroll\");\n\nvar _quill_registrator = require(\"./quill_registrator\");\n\nvar _quill_registrator2 = _interopRequireDefault(_quill_registrator);\n\nrequire(\"./converters/delta\");\n\nvar _converterController = require(\"./converterController\");\n\nvar _converterController2 = _interopRequireDefault(_converterController);\n\nvar _wordLists = require(\"./matchers/wordLists\");\n\nvar _wordLists2 = _interopRequireDefault(_wordLists);\n\nvar _textDecoration = require(\"./matchers/textDecoration\");\n\nvar _textDecoration2 = _interopRequireDefault(_textDecoration);\n\nvar _formDialog = require(\"./ui/formDialog\");\n\nvar _formDialog2 = _interopRequireDefault(_formDialog);\n\nfunction _interopRequireDefault(obj) {\n  return obj && obj.__esModule ? obj : {\n    \"default\": obj\n  };\n}\n\nvar HTML_EDITOR_CLASS = \"dx-htmleditor\";\nvar QUILL_CONTAINER_CLASS = \"dx-quill-container\";\nvar QUILL_CLIPBOARD_CLASS = \"ql-clipboard\";\nvar HTML_EDITOR_SUBMIT_ELEMENT_CLASS = \"dx-htmleditor-submit-element\";\nvar HTML_EDITOR_CONTENT_CLASS = \"dx-htmleditor-content\";\nvar MARKDOWN_VALUE_TYPE = \"markdown\";\nvar ANONYMOUS_TEMPLATE_NAME = \"htmlContent\";\nvar ELEMENT_NODE = 1;\n\nvar HtmlEditor = _editor2.default.inherit({\n  _getDefaultOptions: function _getDefaultOptions() {\n    return (0, _extend.extend)(this.callBase(), {\n      focusStateEnabled: true,\n      valueType: \"html\",\n      placeholder: \"\",\n      toolbar: null,\n      variables: null,\n      mediaResizing: null,\n      mentions: null,\n      customizeModules: null,\n      formDialogOptions: null\n    });\n  },\n  _init: function _init() {\n    this.callBase();\n    this._cleanCallback = (0, _callbacks2.default)();\n    this._contentInitializedCallback = (0, _callbacks2.default)();\n  },\n  _getAnonymousTemplateName: function _getAnonymousTemplateName() {\n    return ANONYMOUS_TEMPLATE_NAME;\n  },\n  _initTemplates: function _initTemplates() {\n    this.callBase();\n    this._defaultTemplates[ANONYMOUS_TEMPLATE_NAME] = new _empty_template.EmptyTemplate();\n  },\n  _focusTarget: function _focusTarget() {\n    return this._getContent();\n  },\n  _getContent: function _getContent() {\n    return this.$element().find(\".\".concat(HTML_EDITOR_CONTENT_CLASS));\n  },\n  _focusInHandler: function _focusInHandler(_ref) {\n    var relatedTarget = _ref.relatedTarget;\n\n    if (this._shouldSkipFocusEvent(relatedTarget)) {\n      return;\n    }\n\n    this._toggleFocusClass(true, this.$element());\n\n    this.callBase.apply(this, arguments);\n  },\n  _focusOutHandler: function _focusOutHandler(_ref2) {\n    var relatedTarget = _ref2.relatedTarget;\n\n    if (this._shouldSkipFocusEvent(relatedTarget)) {\n      return;\n    }\n\n    this._toggleFocusClass(false, this.$element());\n\n    this.callBase.apply(this, arguments);\n  },\n  _shouldSkipFocusEvent: function _shouldSkipFocusEvent(relatedTarget) {\n    return (0, _renderer2.default)(relatedTarget).hasClass(QUILL_CLIPBOARD_CLASS);\n  },\n  _initMarkup: function _initMarkup() {\n    this._$htmlContainer = (0, _renderer2.default)(\"<div>\").addClass(QUILL_CONTAINER_CLASS);\n    this.$element().addClass(HTML_EDITOR_CLASS).wrapInner(this._$htmlContainer);\n\n    var template = this._getTemplate(ANONYMOUS_TEMPLATE_NAME);\n\n    var transclude = true;\n    this._$templateResult = template && template.render({\n      container: (0, _dom.getPublicElement)(this._$htmlContainer),\n      noModel: true,\n      transclude: transclude\n    });\n\n    this._renderSubmitElement();\n\n    this.callBase();\n\n    this._updateContainerMarkup();\n  },\n  _renderSubmitElement: function _renderSubmitElement() {\n    this._$submitElement = (0, _renderer2.default)(\"<textarea>\").addClass(HTML_EDITOR_SUBMIT_ELEMENT_CLASS).attr(\"hidden\", true).appendTo(this.$element());\n\n    this._setSubmitValue(this.option(\"value\"));\n  },\n  _setSubmitValue: function _setSubmitValue(value) {\n    this._getSubmitElement().val(value);\n  },\n  _getSubmitElement: function _getSubmitElement() {\n    return this._$submitElement;\n  },\n  _updateContainerMarkup: function _updateContainerMarkup() {\n    var markup = this.option(\"value\");\n\n    if (this._isMarkdownValue()) {\n      this._prepareMarkdownConverter();\n\n      markup = this._markdownConverter.toHtml(markup);\n    }\n\n    if (markup) {\n      this._$htmlContainer.html(markup);\n    }\n  },\n  _prepareMarkdownConverter: function _prepareMarkdownConverter() {\n    var MarkdownConverter = _converterController2.default.getConverter(\"markdown\");\n\n    if (MarkdownConverter) {\n      this._markdownConverter = new MarkdownConverter();\n    } else {\n      throw _ui2.default.Error(\"E1051\", \"markdown\");\n    }\n  },\n  _render: function _render() {\n    this._prepareConverters();\n\n    this.callBase();\n  },\n  _prepareQuillRegistrator: function _prepareQuillRegistrator() {\n    if (!this._quillRegistrator) {\n      this._quillRegistrator = new _quill_registrator2.default();\n    }\n  },\n  _getRegistrator: function _getRegistrator() {\n    this._prepareQuillRegistrator();\n\n    return this._quillRegistrator;\n  },\n  _prepareConverters: function _prepareConverters() {\n    if (!this._deltaConverter) {\n      var DeltaConverter = _converterController2.default.getConverter(\"delta\");\n\n      if (DeltaConverter) {\n        this._deltaConverter = new DeltaConverter();\n      }\n    }\n\n    if (this.option(\"valueType\") === MARKDOWN_VALUE_TYPE && !this._markdownConverter) {\n      this._prepareMarkdownConverter();\n    }\n  },\n  _renderContentImpl: function _renderContentImpl() {\n    this._contentRenderedDeferred = new _deferred.Deferred();\n\n    var renderContentPromise = this._contentRenderedDeferred.promise();\n\n    this.callBase();\n\n    this._renderHtmlEditor();\n\n    this._renderFormDialog();\n\n    return renderContentPromise;\n  },\n  _renderHtmlEditor: function _renderHtmlEditor() {\n    var _this = this;\n\n    var customizeModules = this.option(\"customizeModules\");\n\n    var modulesConfig = this._getModulesConfig();\n\n    if ((0, _type.isFunction)(customizeModules)) {\n      customizeModules(modulesConfig);\n    }\n\n    this._quillInstance = this._getRegistrator().createEditor(this._$htmlContainer[0], {\n      placeholder: this.option(\"placeholder\"),\n      readOnly: this.option(\"readOnly\") || this.option(\"disabled\"),\n      modules: modulesConfig,\n      theme: \"basic\"\n    });\n\n    this._deltaConverter.setQuillInstance(this._quillInstance);\n\n    this._textChangeHandlerWithContext = this._textChangeHandler.bind(this);\n\n    this._quillInstance.on(\"text-change\", this._textChangeHandlerWithContext);\n\n    this._renderScrollHandler();\n\n    if (this._hasTranscludedContent()) {\n      this._updateContentTask = (0, _common.executeAsync)(function () {\n        _this._applyTranscludedContent();\n      });\n    } else {\n      this._finalizeContentRendering();\n    }\n  },\n  _renderScrollHandler: function _renderScrollHandler() {\n    var $scrollContainer = this._getContent();\n\n    var initScrollData = {\n      validate: function validate(e) {\n        if ((0, _utils.isDxMouseWheelEvent)(e)) {\n          if ((0, _utils2.allowScroll)($scrollContainer, -e.delta, e.shiftKey)) {\n            e._needSkipEvent = true;\n            return true;\n          }\n\n          return false;\n        }\n      }\n    };\n\n    _events_engine2.default.on($scrollContainer, (0, _utils.addNamespace)(_uiEventsEmitterGesture2.default.init, this.NAME), initScrollData, _common.noop);\n  },\n  _applyTranscludedContent: function _applyTranscludedContent() {\n    var markup = this._deltaConverter.toHtml();\n\n    var newDelta = this._quillInstance.clipboard.convert(markup);\n\n    if (newDelta.ops.length) {\n      this._quillInstance.setContents(newDelta);\n    } else {\n      this._finalizeContentRendering();\n    }\n  },\n  _hasTranscludedContent: function _hasTranscludedContent() {\n    return this._$templateResult && this._$templateResult.length;\n  },\n  _getModulesConfig: function _getModulesConfig() {\n    var quill = this._getRegistrator().getQuill();\n\n    var wordListMatcher = (0, _wordLists2.default)(quill);\n    var modulesConfig = (0, _extend.extend)({\n      toolbar: this._getModuleConfigByOption(\"toolbar\"),\n      variables: this._getModuleConfigByOption(\"variables\"),\n      dropImage: this._getBaseModuleConfig(),\n      resizing: this._getModuleConfigByOption(\"mediaResizing\"),\n      mentions: this._getModuleConfigByOption(\"mentions\"),\n      clipboard: {\n        matchVisual: false,\n        matchers: [[\"p.MsoListParagraphCxSpFirst\", wordListMatcher], [\"p.MsoListParagraphCxSpMiddle\", wordListMatcher], [\"p.MsoListParagraphCxSpLast\", wordListMatcher], [ELEMENT_NODE, (0, _textDecoration2.default)(quill)]]\n      }\n    }, this._getCustomModules());\n    return modulesConfig;\n  },\n  _getModuleConfigByOption: function _getModuleConfigByOption(userOptionName) {\n    var optionValue = this.option(userOptionName);\n    var config = {};\n\n    if (!(0, _type.isDefined)(optionValue)) {\n      return;\n    }\n\n    if (Array.isArray(optionValue)) {\n      config[userOptionName] = optionValue;\n    } else {\n      config = optionValue;\n    }\n\n    return (0, _extend.extend)(this._getBaseModuleConfig(), config);\n  },\n  _getBaseModuleConfig: function _getBaseModuleConfig() {\n    return {\n      editorInstance: this\n    };\n  },\n  _getCustomModules: function _getCustomModules() {\n    var _this2 = this;\n\n    var modules = {};\n\n    var moduleNames = this._getRegistrator().getRegisteredModuleNames();\n\n    moduleNames.forEach(function (modulePath) {\n      modules[modulePath] = _this2._getBaseModuleConfig();\n    });\n    return modules;\n  },\n  _textChangeHandler: function _textChangeHandler(newDelta, oldDelta, source) {\n    var htmlMarkup = this._deltaConverter.toHtml();\n\n    var value = this._isMarkdownValue() ? this._updateValueByType(MARKDOWN_VALUE_TYPE, htmlMarkup) : htmlMarkup;\n\n    if (this.option(\"value\") !== value) {\n      this._isEditorUpdating = true;\n      this.option(\"value\", value);\n    }\n\n    this._finalizeContentRendering();\n  },\n  _finalizeContentRendering: function _finalizeContentRendering() {\n    if (this._contentRenderedDeferred) {\n      this.clearHistory();\n\n      this._contentInitializedCallback.fire();\n\n      this._contentRenderedDeferred.resolve();\n\n      this._contentRenderedDeferred = void 0;\n    }\n  },\n  _updateValueByType: function _updateValueByType(valueType, value) {\n    var converter = this._markdownConverter;\n\n    if (!(0, _type.isDefined)(converter)) {\n      return;\n    }\n\n    var currentValue = value || this.option(\"value\");\n    return valueType === MARKDOWN_VALUE_TYPE ? converter.toMarkdown(currentValue) : converter.toHtml(currentValue);\n  },\n  _isMarkdownValue: function _isMarkdownValue() {\n    return this.option(\"valueType\") === MARKDOWN_VALUE_TYPE;\n  },\n  _resetEnabledState: function _resetEnabledState() {\n    if (this._quillInstance) {\n      var isEnabled = !(this.option(\"readOnly\") || this.option(\"disabled\"));\n\n      this._quillInstance.enable(isEnabled);\n    }\n  },\n  _renderFormDialog: function _renderFormDialog() {\n    var userOptions = (0, _extend.extend)(true, {\n      width: \"auto\",\n      height: \"auto\",\n      closeOnOutsideClick: true\n    }, this.option(\"formDialogOptions\"));\n    this._formDialog = new _formDialog2.default(this, userOptions);\n  },\n  _getQuillContainer: function _getQuillContainer() {\n    return this._$htmlContainer;\n  },\n  _optionChanged: function _optionChanged(args) {\n    switch (args.name) {\n      case \"value\":\n        if (this._quillInstance) {\n          if (this._isEditorUpdating) {\n            this._isEditorUpdating = false;\n          } else {\n            var updatedValue = this._isMarkdownValue() ? this._updateValueByType(\"HTML\", args.value) : args.value;\n\n            this._updateHtmlContent(updatedValue);\n          }\n        } else {\n          this._$htmlContainer.html(args.value);\n        }\n\n        this._setSubmitValue(args.value);\n\n        this.callBase(args);\n        break;\n\n      case \"placeholder\":\n      case \"variables\":\n      case \"toolbar\":\n      case \"mentions\":\n      case \"customizeModules\":\n        this._invalidate();\n\n        break;\n\n      case \"valueType\":\n        this._prepareConverters();\n\n        var newValue = this._updateValueByType(args.value);\n\n        if (\"html\" === args.value && this._quillInstance) {\n          this._updateHtmlContent(newValue);\n        } else {\n          this.option(\"value\", newValue);\n        }\n\n        break;\n\n      case \"readOnly\":\n      case \"disabled\":\n        this.callBase(args);\n\n        this._resetEnabledState();\n\n        break;\n\n      case \"formDialogOptions\":\n        this._renderFormDialog();\n\n        break;\n\n      case \"mediaResizing\":\n        if (!args.previousValue || !args.value) {\n          this._invalidate();\n        } else {\n          this._quillInstance.getModule(\"resizing\").option(args.name, args.value);\n        }\n\n        break;\n\n      case \"width\":\n        this.callBase(args);\n\n        this._repaintToolbar();\n\n        break;\n\n      default:\n        this.callBase(args);\n    }\n  },\n  _repaintToolbar: function _repaintToolbar() {\n    var toolbar = this._quillInstance.getModule(\"toolbar\");\n\n    toolbar && toolbar.repaint();\n  },\n  _updateHtmlContent: function _updateHtmlContent(newMarkup) {\n    var newDelta = this._quillInstance.clipboard.convert(newMarkup);\n\n    this._quillInstance.setContents(newDelta);\n  },\n  _clean: function _clean() {\n    if (this._quillInstance) {\n      _events_engine2.default.off(this._getContent(), \".\".concat(this.NAME));\n\n      this._quillInstance.off(\"text-change\", this._textChangeHandlerWithContext);\n\n      this._cleanCallback.fire();\n    }\n\n    this._abortUpdateContentTask();\n\n    this._cleanCallback.empty();\n\n    this._contentInitializedCallback.empty();\n\n    this.callBase();\n  },\n  _abortUpdateContentTask: function _abortUpdateContentTask() {\n    if (this._updateContentTask) {\n      this._updateContentTask.abort();\n\n      this._updateContentTask = void 0;\n    }\n  },\n  _applyQuillMethod: function _applyQuillMethod(methodName, args) {\n    if (this._quillInstance) {\n      return this._quillInstance[methodName].apply(this._quillInstance, args);\n    }\n  },\n  _applyQuillHistoryMethod: function _applyQuillHistoryMethod(methodName) {\n    if (this._quillInstance && this._quillInstance.history) {\n      this._quillInstance.history[methodName]();\n    }\n  },\n  addCleanCallback: function addCleanCallback(callback) {\n    this._cleanCallback.add(callback);\n  },\n  addContentInitializedCallback: function addContentInitializedCallback(callback) {\n    this._contentInitializedCallback.add(callback);\n  },\n  register: function register(components) {\n    this._getRegistrator().registerModules(components);\n\n    if (this._quillInstance) {\n      this.repaint();\n    }\n  },\n  get: function get(modulePath) {\n    return this._getRegistrator().getQuill().import(modulePath);\n  },\n  getQuillInstance: function getQuillInstance() {\n    return this._quillInstance;\n  },\n  getSelection: function getSelection() {\n    return this._applyQuillMethod(\"getSelection\");\n  },\n  setSelection: function setSelection(index, length) {\n    this._applyQuillMethod(\"setSelection\", arguments);\n  },\n  format: function format(formatName, formatValue) {\n    this._applyQuillMethod(\"format\", arguments);\n  },\n  formatText: function formatText(index, length, formatName, formatValue) {\n    this._applyQuillMethod(\"formatText\", arguments);\n  },\n  formatLine: function formatLine(index, length, formatName, formatValue) {\n    this._applyQuillMethod(\"formatLine\", arguments);\n  },\n  getFormat: function getFormat(index, length) {\n    return this._applyQuillMethod(\"getFormat\", arguments);\n  },\n  removeFormat: function removeFormat(index, length) {\n    return this._applyQuillMethod(\"removeFormat\", arguments);\n  },\n  clearHistory: function clearHistory() {\n    this._applyQuillHistoryMethod(\"clear\");\n  },\n  undo: function undo() {\n    this._applyQuillHistoryMethod(\"undo\");\n  },\n  redo: function redo() {\n    this._applyQuillHistoryMethod(\"redo\");\n  },\n  getLength: function getLength() {\n    return this._applyQuillMethod(\"getLength\");\n  },\n  \"delete\": function _delete(index, length) {\n    this._applyQuillMethod(\"deleteText\", arguments);\n  },\n  insertText: function insertText(index, text, formats) {\n    this._applyQuillMethod(\"insertText\", arguments);\n  },\n  insertEmbed: function insertEmbed(index, type, config) {\n    this._applyQuillMethod(\"insertEmbed\", arguments);\n  },\n  showFormDialog: function showFormDialog(formConfig) {\n    return this._formDialog.show(formConfig);\n  },\n  formDialogOption: function formDialogOption(optionName, optionValue) {\n    return this._formDialog.popupOption.apply(this._formDialog, arguments);\n  },\n  focus: function focus() {\n    this.callBase();\n\n    this._applyQuillMethod(\"focus\");\n  }\n});\n\n(0, _component_registrator2.default)(\"dxHtmlEditor\", HtmlEditor);\nmodule.exports = HtmlEditor;","map":null,"metadata":{},"sourceType":"script"}