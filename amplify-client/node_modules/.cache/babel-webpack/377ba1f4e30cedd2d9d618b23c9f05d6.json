{"ast":null,"code":"/**\r\n * DevExtreme (ui/pivot_grid/ui.pivot_grid.field_chooser.js)\r\n * Version: 19.2.6\r\n * Build date: Thu Jan 30 2020\r\n *\r\n * Copyright (c) 2012 - 2020 Developer Express Inc. ALL RIGHTS RESERVED\r\n * Read about DevExtreme licensing here: https://js.devexpress.com/Licensing/\r\n */\n\"use strict\";\n\nvar _renderer = require(\"../../core/renderer\");\n\nvar _renderer2 = _interopRequireDefault(_renderer);\n\nvar _icon = require(\"../../core/utils/icon\");\n\nvar _window = require(\"../../core/utils/window\");\n\nvar _type = require(\"../../core/utils/type\");\n\nvar _extend = require(\"../../core/utils/extend\");\n\nvar _array = require(\"../../core/utils/array\");\n\nvar _iterator = require(\"../../core/utils/iterator\");\n\nvar _message = require(\"../../localization/message\");\n\nvar _component_registrator = require(\"../../core/component_registrator\");\n\nvar _component_registrator2 = _interopRequireDefault(_component_registrator);\n\nvar _uiPivot_grid = require(\"./ui.pivot_grid.utils\");\n\nvar _tree_view = require(\"../tree_view\");\n\nvar _tree_view2 = _interopRequireDefault(_tree_view);\n\nvar _context_menu = require(\"../context_menu\");\n\nvar _context_menu2 = _interopRequireDefault(_context_menu);\n\nvar _uiPivot_grid2 = require(\"./ui.pivot_grid.field_chooser_base\");\n\nvar _uiPivot_grid3 = _interopRequireDefault(_uiPivot_grid2);\n\nrequire(\"./data_source\");\n\nfunction _interopRequireDefault(obj) {\n  return obj && obj.__esModule ? obj : {\n    \"default\": obj\n  };\n}\n\nvar DIV = \"<div>\";\nvar hasWindow = (0, _window.hasWindow)();\nvar FIELDCHOOSER_CLASS = \"dx-pivotgridfieldchooser\";\nvar FIELDCHOOSER_CONTAINER_CLASS = \"dx-pivotgridfieldchooser-container\";\nvar FIELDS_CONTAINER_CLASS = \"dx-pivotgrid-fields-container\";\nvar AREA_DRAG_CLASS = \"dx-pivotgrid-drag-action\";\n\nfunction getDimensionFields(item, fields) {\n  var result = [];\n\n  if (item.items) {\n    for (var i = 0; i < item.items.length; i++) {\n      result.push.apply(result, getDimensionFields(item.items[i], fields));\n    }\n  } else {\n    if ((0, _type.isDefined)(item.index)) {\n      result.push(fields[item.index]);\n    }\n  }\n\n  return result;\n}\n\nfunction getFirstItem(item, condition) {\n  if (item.items) {\n    for (var i = 0; i < item.items.length; i++) {\n      var childrenItem = getFirstItem(item.items[i], condition);\n\n      if (childrenItem) {\n        return childrenItem;\n      }\n    }\n  }\n\n  if (condition(item)) {\n    return item;\n  }\n}\n\nvar compareOrder = [function (a, b) {\n  var aValue = -!!a.isMeasure;\n  var bValue = +!!b.isMeasure;\n  return aValue + bValue;\n}, function (a, b) {\n  var aValue = -!!(a.items && a.items.length);\n  var bValue = +!!(b.items && b.items.length);\n  return aValue + bValue;\n}, function (a, b) {\n  var aValue = +!!(false === a.isMeasure && a.field && a.field.levels && a.field.levels.length);\n  var bValue = -!!(false === b.isMeasure && b.field && b.field.levels && b.field.levels.length);\n  return aValue + bValue;\n}, (0, _uiPivot_grid.getCompareFunction)(function (item) {\n  return item.text;\n})];\n\nfunction compareItems(a, b) {\n  var result = 0;\n  var i = 0;\n\n  while (!result && compareOrder[i]) {\n    result = compareOrder[i++](a, b);\n  }\n\n  return result;\n}\n\nfunction getScrollable(container) {\n  return container.find(\".dx-scrollable\").dxScrollable(\"instance\");\n}\n\nvar FieldChooser = _uiPivot_grid3.default.inherit({\n  _getDefaultOptions: function _getDefaultOptions() {\n    return (0, _extend.extend)(this.callBase(), {\n      height: 400,\n      layout: 0,\n      dataSource: null,\n      onContextMenuPreparing: null,\n      allowSearch: false,\n      searchTimeout: 500,\n      texts: {\n        columnFields: (0, _message.format)(\"dxPivotGrid-columnFields\"),\n        rowFields: (0, _message.format)(\"dxPivotGrid-rowFields\"),\n        dataFields: (0, _message.format)(\"dxPivotGrid-dataFields\"),\n        filterFields: (0, _message.format)(\"dxPivotGrid-filterFields\"),\n        allFields: (0, _message.format)(\"dxPivotGrid-allFields\")\n      }\n    });\n  },\n  _refreshDataSource: function _refreshDataSource() {\n    var that = this;\n    that._expandedPaths = [];\n\n    that._changedHandler = that._changedHandler || function () {\n      (0, _iterator.each)(that._dataChangedHandlers, function (_, func) {\n        func();\n      });\n\n      that._fireContentReadyAction();\n\n      that._skipStateChange = true;\n      that.option(\"state\", that._dataSource.state());\n      that._skipStateChange = false;\n    };\n\n    that._disposeDataSource();\n\n    that.callBase();\n    that._dataSource && that._dataSource.on(\"changed\", that._changedHandler);\n  },\n  _disposeDataSource: function _disposeDataSource() {\n    var that = this;\n    var dataSource = that._dataSource;\n\n    if (dataSource) {\n      dataSource.off(\"changed\", that._changedHandler);\n      that._dataSource = void 0;\n    }\n  },\n  _dispose: function _dispose() {\n    this._disposeDataSource();\n\n    this.callBase.apply(this, arguments);\n  },\n  _init: function _init() {\n    this.callBase();\n\n    this._refreshDataSource();\n\n    this._dataChangedHandlers = [];\n\n    this._initActions();\n  },\n  _initActions: function _initActions() {\n    this._actions = {\n      onContextMenuPreparing: this._createActionByOption(\"onContextMenuPreparing\")\n    };\n  },\n  _trigger: function _trigger(eventName, eventArg) {\n    this._actions[eventName](eventArg);\n  },\n  _setOptionsByReference: function _setOptionsByReference() {\n    this.callBase();\n    (0, _extend.extend)(this._optionsByReference, {\n      dataSource: true\n    });\n  },\n  _optionChanged: function _optionChanged(args) {\n    var that = this;\n\n    switch (args.name) {\n      case \"dataSource\":\n        that._refreshDataSource();\n\n        that._invalidate();\n\n        break;\n\n      case \"layout\":\n      case \"texts\":\n      case \"allowSearch\":\n      case \"searchTimeout\":\n        that._invalidate();\n\n        break;\n\n      case \"onContextMenuPreparing\":\n        that._actions[args.name] = that._createActionByOption(args.name);\n        break;\n\n      default:\n        that.callBase(args);\n    }\n  },\n  _clean: function _clean(skipStateSetting) {\n    !skipStateSetting && this._dataSource && this.option(\"state\", this._dataSource.state());\n    this.$element().children(\".\" + FIELDCHOOSER_CONTAINER_CLASS).remove();\n  },\n  _renderLayout0: function _renderLayout0($container) {\n    var that = this;\n    $container.addClass(\"dx-layout-0\");\n    var $row1 = (0, _renderer2.default)(DIV).addClass(\"dx-row\").appendTo($container);\n    var $row2 = (0, _renderer2.default)(DIV).addClass(\"dx-row\").appendTo($container);\n    var $col1 = (0, _renderer2.default)(DIV).addClass(\"dx-col\").appendTo($row1);\n    var $col2 = (0, _renderer2.default)(DIV).addClass(\"dx-col\").appendTo($row1);\n    var $col3 = (0, _renderer2.default)(DIV).addClass(\"dx-col\").appendTo($row2);\n    var $col4 = (0, _renderer2.default)(DIV).addClass(\"dx-col\").appendTo($row2);\n\n    that._renderArea($col1, \"all\");\n\n    that._renderArea($col2, \"row\");\n\n    that._renderArea($col2, \"column\");\n\n    that._renderArea($col3, \"filter\");\n\n    that._renderArea($col4, \"data\");\n  },\n  _renderLayout1: function _renderLayout1($container) {\n    var that = this;\n    var $col1 = (0, _renderer2.default)(DIV).addClass(\"dx-col\").appendTo($container);\n    var $col2 = (0, _renderer2.default)(DIV).addClass(\"dx-col\").appendTo($container);\n\n    that._renderArea($col1, \"all\");\n\n    that._renderArea($col2, \"filter\");\n\n    that._renderArea($col2, \"row\");\n\n    that._renderArea($col2, \"column\");\n\n    that._renderArea($col2, \"data\");\n  },\n  _renderLayout2: function _renderLayout2($container) {\n    var that = this;\n    $container.addClass(\"dx-layout-2\");\n    var $row1 = (0, _renderer2.default)(DIV).addClass(\"dx-row\").appendTo($container);\n\n    that._renderArea($row1, \"all\");\n\n    var $row2 = (0, _renderer2.default)(DIV).addClass(\"dx-row\").appendTo($container);\n    var $col1 = (0, _renderer2.default)(DIV).addClass(\"dx-col\").appendTo($row2);\n    var $col2 = (0, _renderer2.default)(DIV).addClass(\"dx-col\").appendTo($row2);\n\n    that._renderArea($col1, \"filter\");\n\n    that._renderArea($col1, \"row\");\n\n    that._renderArea($col2, \"column\");\n\n    that._renderArea($col2, \"data\");\n  },\n  _initMarkup: function _initMarkup() {\n    var that = this;\n    var $element = this.$element();\n    var $container = (0, _renderer2.default)(DIV).addClass(FIELDCHOOSER_CONTAINER_CLASS).appendTo($element);\n    var layout = that.option(\"layout\");\n    that.callBase();\n    $element.addClass(FIELDCHOOSER_CLASS).addClass(FIELDS_CONTAINER_CLASS);\n    that._dataChangedHandlers = [];\n    var dataSource = this._dataSource;\n    var currentState = \"instantly\" !== that.option(\"applyChangesMode\") && dataSource && dataSource.state();\n    currentState && that.option(\"state\") && dataSource.state(that.option(\"state\"), true);\n\n    if (0 === layout) {\n      that._renderLayout0($container);\n    } else {\n      if (1 === layout) {\n        that._renderLayout1($container);\n      } else {\n        that._renderLayout2($container);\n      }\n    }\n\n    currentState && dataSource.state(currentState, true);\n  },\n  _renderContentImpl: function _renderContentImpl() {\n    this.callBase();\n    this.renderSortable();\n\n    this._renderContextMenu();\n\n    this.updateDimensions();\n  },\n  _fireContentReadyAction: function _fireContentReadyAction() {\n    if (!this._dataSource || !this._dataSource.isLoading()) {\n      this.callBase();\n    }\n  },\n  _getContextMenuArgs: function _getContextMenuArgs(dxEvent) {\n    var targetFieldElement = (0, _renderer2.default)(dxEvent.target).closest(\".dx-area-field\");\n    var targetGroupElement = (0, _renderer2.default)(dxEvent.target).closest(\".dx-area-fields\");\n    var field;\n    var area;\n\n    if (targetFieldElement.length) {\n      var fieldCopy = targetFieldElement.data(\"field\");\n\n      if (fieldCopy) {\n        field = this.getDataSource().field(fieldCopy.index) || fieldCopy;\n      }\n    }\n\n    if (targetGroupElement.length) {\n      area = targetGroupElement.attr(\"group\");\n    }\n\n    return {\n      event: dxEvent,\n      field: field,\n      area: area,\n      items: []\n    };\n  },\n  _renderContextMenu: function _renderContextMenu() {\n    var that = this;\n    var $container = that.$element();\n\n    if (that._contextMenu) {\n      that._contextMenu.$element().remove();\n    }\n\n    that._contextMenu = that._createComponent((0, _renderer2.default)(DIV).appendTo($container), _context_menu2.default, {\n      onPositioning: function onPositioning(actionArgs) {\n        var event = actionArgs.event;\n\n        if (!event) {\n          return;\n        }\n\n        var args = that._getContextMenuArgs(event);\n\n        that._trigger(\"onContextMenuPreparing\", args);\n\n        if (args.items && args.items.length) {\n          actionArgs.component.option(\"items\", args.items);\n        } else {\n          actionArgs.cancel = true;\n        }\n      },\n      target: $container,\n      onItemClick: function onItemClick(params) {\n        params.itemData.onItemClick && params.itemData.onItemClick(params);\n      },\n      cssClass: \"dx-pivotgridfieldchooser-context-menu\"\n    });\n  },\n  _createTreeItems: function _createTreeItems(fields, groupFieldNames, path) {\n    var that = this;\n    var isMeasure;\n    var resultItems = [];\n    var groupedItems = [];\n    var groupFieldName = groupFieldNames[0];\n    var fieldsByGroup = {};\n\n    if (!groupFieldName) {\n      (0, _iterator.each)(fields, function (index, field) {\n        var icon;\n\n        if (true === field.isMeasure) {\n          icon = \"measure\";\n        }\n\n        if (false === field.isMeasure) {\n          icon = field.groupName ? \"hierarchy\" : \"dimension\";\n        }\n\n        resultItems.push({\n          index: field.index,\n          field: field,\n          key: field.dataField,\n          selected: (0, _type.isDefined)(field.area),\n          text: field.caption || field.dataField,\n          icon: icon,\n          isMeasure: field.isMeasure,\n          isDefault: field.isDefault\n        });\n      });\n    } else {\n      (0, _iterator.each)(fields, function (index, field) {\n        var groupName = field[groupFieldName] || \"\";\n        fieldsByGroup[groupName] = fieldsByGroup[groupName] || [];\n        fieldsByGroup[groupName].push(field);\n\n        if (void 0 === isMeasure) {\n          isMeasure = true;\n        }\n\n        isMeasure = isMeasure && true === field.isMeasure;\n      });\n      (0, _iterator.each)(fieldsByGroup, function (groupName, fields) {\n        var currentPath = path ? path + \".\" + groupName : groupName;\n\n        var items = that._createTreeItems(fields, groupFieldNames.slice(1), currentPath);\n\n        if (groupName) {\n          groupedItems.push({\n            key: groupName,\n            text: groupName,\n            path: currentPath,\n            isMeasure: items.isMeasure,\n            expanded: (0, _array.inArray)(currentPath, that._expandedPaths) >= 0,\n            items: items\n          });\n        } else {\n          resultItems = items;\n        }\n      });\n      resultItems = groupedItems.concat(resultItems);\n      resultItems.isMeasure = isMeasure;\n    }\n\n    return resultItems;\n  },\n  _createFieldsDataSource: function _createFieldsDataSource(dataSource) {\n    var fields = dataSource && dataSource.fields() || [];\n    fields = fields.filter(function (field) {\n      return false !== field.visible && !(0, _type.isDefined)(field.groupIndex);\n    });\n\n    var treeItems = this._createTreeItems(fields, [\"dimension\", \"displayFolder\"]);\n\n    (0, _uiPivot_grid.foreachDataLevel)(treeItems, function (items) {\n      items.sort(compareItems);\n    }, 0, \"items\");\n    return treeItems;\n  },\n  _renderFieldsTreeView: function _renderFieldsTreeView(container) {\n    var that = this;\n    var dataSource = that._dataSource;\n\n    var treeView = that._createComponent(container, _tree_view2.default, {\n      dataSource: that._createFieldsDataSource(dataSource),\n      showCheckBoxesMode: \"normal\",\n      searchEnabled: that.option(\"allowSearch\"),\n      searchTimeout: that.option(\"searchTimeout\"),\n      itemTemplate: function itemTemplate(itemData, itemIndex, itemElement) {\n        if (itemData.icon) {\n          (0, _icon.getImageContainer)(itemData.icon).appendTo(itemElement);\n        }\n\n        (0, _renderer2.default)(\"<span>\").toggleClass(\"dx-area-field\", !itemData.items).data(\"field\", itemData.field).text(itemData.text).appendTo(itemElement);\n      },\n      onItemCollapsed: function onItemCollapsed(e) {\n        var index = (0, _array.inArray)(e.itemData.path, that._expandedPaths);\n\n        if (index >= 0) {\n          that._expandedPaths.splice(index, 1);\n        }\n      },\n      onItemExpanded: function onItemExpanded(e) {\n        var index = (0, _array.inArray)(e.itemData.path, that._expandedPaths);\n\n        if (index < 0) {\n          that._expandedPaths.push(e.itemData.path);\n        }\n      },\n      onItemSelectionChanged: function onItemSelectionChanged(e) {\n        var data = e.itemData;\n        var field;\n        var fields;\n        var needSelectDefaultItem = true;\n        var area;\n\n        if (data.items) {\n          if (data.selected) {\n            treeView.unselectItem(data);\n            return;\n          }\n\n          that._processDemandState(function () {\n            fields = getDimensionFields(data, dataSource.fields());\n\n            for (var i = 0; i < fields.length; i++) {\n              if (fields[i].area) {\n                needSelectDefaultItem = false;\n                break;\n              }\n            }\n          });\n\n          if (needSelectDefaultItem) {\n            var item = getFirstItem(data, function (item) {\n              return item.isDefault;\n            }) || getFirstItem(data, function (item) {\n              return (0, _type.isDefined)(item.index);\n            });\n            item && treeView.selectItem(item);\n            return;\n          }\n        } else {\n          field = dataSource.fields()[data.index];\n\n          if (data.selected) {\n            area = field.isMeasure ? \"data\" : \"column\";\n          }\n\n          if (field) {\n            fields = [field];\n          }\n        }\n\n        that._applyChanges(fields, {\n          area: area,\n          areaIndex: void 0\n        });\n      }\n    });\n\n    var dataChanged = function dataChanged() {\n      var scrollable = getScrollable(container);\n      var scrollTop = scrollable ? scrollable.scrollTop() : 0;\n      treeView.option({\n        dataSource: that._createFieldsDataSource(dataSource)\n      });\n      scrollable = getScrollable(container);\n\n      if (scrollable) {\n        scrollable.scrollTo({\n          y: scrollTop\n        });\n        scrollable.update();\n      }\n    };\n\n    that._dataChangedHandlers.push(dataChanged);\n  },\n  _renderAreaFields: function _renderAreaFields($container, area) {\n    var that = this;\n    var dataSource = that._dataSource;\n    var fields = dataSource ? (0, _extend.extend)(true, [], dataSource.getAreaFields(area, true)) : [];\n    $container.empty();\n    (0, _iterator.each)(fields, function (_, field) {\n      if (false !== field.visible) {\n        that.renderField(field, true).appendTo($container);\n      }\n    });\n  },\n  _renderArea: function _renderArea(container, area) {\n    var that = this;\n    var $areaContainer = (0, _renderer2.default)(DIV).addClass(\"dx-area\").appendTo(container);\n    var $fieldsHeaderContainer = (0, _renderer2.default)(DIV).addClass(\"dx-area-fields-header\").appendTo($areaContainer);\n    var caption = that.option(\"texts.\" + area + \"Fields\");\n    var $fieldsContent;\n    var render;\n    (0, _renderer2.default)(\"<span>\").addClass(\"dx-area-icon\").addClass(\"dx-area-icon-\" + area).appendTo($fieldsHeaderContainer);\n    (0, _renderer2.default)(\"<span>\").html(\"&nbsp;\").appendTo($fieldsHeaderContainer);\n    (0, _renderer2.default)(\"<span>\").addClass(\"dx-area-caption\").text(caption).appendTo($fieldsHeaderContainer);\n    var $fieldsContainer = (0, _renderer2.default)(DIV).addClass(\"dx-area-fields\").addClass(AREA_DRAG_CLASS).appendTo($areaContainer);\n\n    if (\"all\" !== area) {\n      $fieldsContainer.attr(\"group\", area).attr(\"allow-scrolling\", true);\n      $fieldsContent = (0, _renderer2.default)(DIV).addClass(\"dx-area-field-container\").appendTo($fieldsContainer);\n\n      render = function render() {\n        that._renderAreaFields($fieldsContent, area);\n      };\n\n      that._dataChangedHandlers.push(render);\n\n      render();\n      $fieldsContainer.dxScrollable();\n    } else {\n      $areaContainer.addClass(\"dx-all-fields\");\n      $fieldsContainer.addClass(\"dx-treeview-border-visible\");\n\n      that._renderFieldsTreeView($fieldsContainer);\n    }\n  },\n  _getSortableOptions: function _getSortableOptions() {\n    return {};\n  },\n  _adjustSortableOnChangedArgs: function _adjustSortableOnChangedArgs() {},\n  resetTreeView: function resetTreeView() {\n    var treeView = this.$element().find(\".dx-treeview\").dxTreeView(\"instance\");\n\n    if (treeView) {\n      treeView.option(\"searchValue\", \"\");\n      treeView.collapseAll();\n    }\n  },\n  applyChanges: function applyChanges() {\n    var state = this.option(\"state\");\n\n    if ((0, _type.isDefined)(state)) {\n      this._dataSource.state(state);\n    }\n  },\n  cancelChanges: function cancelChanges() {\n    var dataSource = this._dataSource;\n\n    if (!dataSource.isLoading()) {\n      this.option(\"state\", dataSource.state());\n      return true;\n    }\n\n    return false;\n  },\n  getDataSource: function getDataSource() {\n    return this._dataSource;\n  },\n  updateDimensions: function updateDimensions() {\n    var $scrollableElements = this.$element().find(\".dx-area .dx-scrollable\");\n    $scrollableElements.dxScrollable(\"update\");\n  },\n  _visibilityChanged: function _visibilityChanged(visible) {\n    if (visible && hasWindow) {\n      this.updateDimensions();\n    }\n  }\n});\n\n(0, _component_registrator2.default)(\"dxPivotGridFieldChooser\", FieldChooser);\nmodule.exports = FieldChooser;","map":null,"metadata":{},"sourceType":"script"}