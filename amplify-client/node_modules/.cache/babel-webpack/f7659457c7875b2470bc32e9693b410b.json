{"ast":null,"code":"/**\r\n * DevExtreme (ui/pivot_grid/ui.pivot_grid.export.js)\r\n * Version: 19.2.6\r\n * Build date: Thu Jan 30 2020\r\n *\r\n * Copyright (c) 2012 - 2020 Developer Express Inc. ALL RIGHTS RESERVED\r\n * Read about DevExtreme licensing here: https://js.devexpress.com/Licensing/\r\n */\n\"use strict\";\n\nvar _class = require(\"../../core/class\");\n\nvar _class2 = _interopRequireDefault(_class);\n\nvar _type = require(\"../../core/utils/type\");\n\nvar _extend = require(\"../../core/utils/extend\");\n\nvar _iterator = require(\"../../core/utils/iterator\");\n\nvar _format_helper = require(\"../../format_helper\");\n\nvar _number = require(\"../../localization/number\");\n\nvar _exporter = require(\"../../exporter\");\n\nvar _exporter2 = _interopRequireDefault(_exporter);\n\nvar _uiGrid_core = require(\"../grid_core/ui.grid_core.export_mixin\");\n\nvar _uiGrid_core2 = _interopRequireDefault(_uiGrid_core);\n\nvar _deferred = require(\"../../core/utils/deferred\");\n\nfunction _interopRequireDefault(obj) {\n  return obj && obj.__esModule ? obj : {\n    \"default\": obj\n  };\n}\n\nvar DEFAULT_DATA_TYPE = \"string\";\nvar COLUMN_HEADER_STYLE_ID = 0;\nvar ROW_HEADER_STYLE_ID = 1;\nvar DATA_STYLE_OFFSET = 2;\nvar DEFAUL_COLUMN_WIDTH = 100;\nexports.ExportMixin = (0, _extend.extend)({}, _uiGrid_core2.default, {\n  exportToExcel: function exportToExcel() {\n    var that = this;\n\n    _exporter2.default.export(that.getDataProvider(), {\n      fileName: that.option(\"export.fileName\"),\n      proxyUrl: that.option(\"export.proxyUrl\"),\n      format: \"EXCEL\",\n      rtlEnabled: that.option(\"rtlEnabled\"),\n      ignoreErrors: that.option(\"export.ignoreExcelErrors\"),\n      exportingAction: that._actions.onExporting,\n      exportedAction: that._actions.onExported,\n      fileSavingAction: that._actions.onFileSaving\n    }, _exporter.excel.getData);\n  },\n  _getLength: function _getLength(items) {\n    var i;\n    var itemCount = items[0].length;\n    var cellCount = 0;\n\n    for (i = 0; i < itemCount; i++) {\n      cellCount += items[0][i].colspan || 1;\n    }\n\n    return cellCount;\n  },\n  _correctCellsInfoItemLengths: function _correctCellsInfoItemLengths(cellsInfo, expectedLength) {\n    for (var i = 0; i < cellsInfo.length; i++) {\n      while (cellsInfo[i].length < expectedLength) {\n        cellsInfo[i].push({});\n      }\n    }\n\n    return cellsInfo;\n  },\n  _calculateCellInfoItemLength: function _calculateCellInfoItemLength(columnsRow) {\n    var result = 0;\n\n    for (var columnIndex = 0; columnIndex < columnsRow.length; columnIndex++) {\n      result += (0, _type.isDefined)(columnsRow[columnIndex].colspan) ? columnsRow[columnIndex].colspan : 1;\n    }\n\n    return result;\n  },\n  _getAllItems: function _getAllItems(columnsInfo, rowsInfoItems, cellsInfo) {\n    var cellIndex;\n    var rowIndex;\n    var correctedCellsInfo = cellsInfo;\n\n    var rowsLength = this._getLength(rowsInfoItems);\n\n    var headerRowsCount = columnsInfo.length;\n\n    if (columnsInfo.length > 0 && columnsInfo[0].length > 0 && cellsInfo.length > 0 && 0 === cellsInfo[0].length) {\n      var cellInfoItemLength = this._calculateCellInfoItemLength(columnsInfo[0]);\n\n      if (cellInfoItemLength > 0) {\n        correctedCellsInfo = this._correctCellsInfoItemLengths(cellsInfo, cellInfoItemLength);\n      }\n    }\n\n    var sourceItems = columnsInfo.concat(correctedCellsInfo);\n\n    for (rowIndex = 0; rowIndex < rowsInfoItems.length; rowIndex++) {\n      for (cellIndex = rowsInfoItems[rowIndex].length - 1; cellIndex >= 0; cellIndex--) {\n        if (!(0, _type.isDefined)(sourceItems[rowIndex + headerRowsCount])) {\n          sourceItems[rowIndex + headerRowsCount] = [];\n        }\n\n        sourceItems[rowIndex + headerRowsCount].splice(0, 0, (0, _extend.extend)({}, rowsInfoItems[rowIndex][cellIndex]));\n      }\n    }\n\n    sourceItems[0].splice(0, 0, (0, _extend.extend)({}, this._getEmptyCell(), {\n      alignment: this._options.rtlEnabled ? \"right\" : \"left\",\n      colspan: rowsLength,\n      rowspan: headerRowsCount\n    }));\n    return this._prepareItems(sourceItems);\n  },\n  getDataProvider: function getDataProvider() {\n    var that = this;\n    var dataController = this._dataController;\n    var items = new _deferred.Deferred();\n    dataController.beginLoading();\n    setTimeout(function () {\n      var columnsInfo = (0, _extend.extend)(true, [], dataController.getColumnsInfo(true));\n      var rowsInfoItems = (0, _extend.extend)(true, [], dataController.getRowsInfo(true));\n      var cellsInfo = dataController.getCellsInfo(true);\n      items.resolve(that._getAllItems(columnsInfo, rowsInfoItems, cellsInfo));\n      dataController.endLoading();\n    });\n    return new exports.DataProvider({\n      items: items,\n      rtlEnabled: this.option(\"rtlEnabled\"),\n      dataFields: this.getDataSource().getAreaFields(\"data\"),\n      customizeExcelCell: this.option(\"export.customizeExcelCell\")\n    });\n  }\n});\n\nfunction getCellDataType(field) {\n  if (field && field.customizeText) {\n    return \"string\";\n  }\n\n  if (field.dataType) {\n    return field.dataType;\n  }\n\n  if (field.format) {\n    if (1 === (0, _number.parse)((0, _format_helper.format)(1, field.format))) {\n      return \"number\";\n    }\n\n    if ((0, _format_helper.format)(new Date(), field.format)) {\n      return \"date\";\n    }\n  }\n\n  return DEFAULT_DATA_TYPE;\n}\n\nexports.DataProvider = _class2.default.inherit({\n  ctor: function ctor(options) {\n    this._options = options;\n    this._styles = [];\n  },\n  ready: function ready() {\n    var that = this;\n    var options = that._options;\n    var dataFields = options.dataFields;\n    return (0, _deferred.when)(options.items).done(function (items) {\n      var headerSize = items[0][0].rowspan;\n      var columns = items[headerSize - 1];\n      var dataItemStyle = {\n        alignment: options.rtlEnabled ? \"left\" : \"right\"\n      };\n      that._styles = [{\n        alignment: \"center\",\n        dataType: \"string\"\n      }, {\n        alignment: options.rtlEnabled ? \"right\" : \"left\",\n        dataType: \"string\"\n      }];\n\n      if (dataFields.length) {\n        dataFields.forEach(function (dataField) {\n          that._styles.push((0, _extend.extend)({}, dataItemStyle, {\n            format: dataField.format,\n            dataType: getCellDataType(dataField)\n          }));\n        });\n      } else {\n        that._styles.push(dataItemStyle);\n      }\n\n      (0, _iterator.each)(columns, function (columnIndex, column) {\n        column.width = DEFAUL_COLUMN_WIDTH;\n      });\n      options.columns = columns;\n      options.items = items;\n    });\n  },\n  getColumns: function getColumns() {\n    return this._options.columns;\n  },\n  getRowsCount: function getRowsCount() {\n    return this._options.items.length;\n  },\n  getGroupLevel: function getGroupLevel() {\n    return 0;\n  },\n  getCellMerging: function getCellMerging(rowIndex, cellIndex) {\n    var items = this._options.items;\n    var item = items[rowIndex] && items[rowIndex][cellIndex];\n    return item ? {\n      colspan: item.colspan - 1,\n      rowspan: item.rowspan - 1\n    } : {\n      colspan: 0,\n      rowspan: 0\n    };\n  },\n  getFrozenArea: function getFrozenArea() {\n    var items = this._options.items;\n    return {\n      x: items[0][0].colspan,\n      y: items[0][0].rowspan\n    };\n  },\n  getCellType: function getCellType(rowIndex, cellIndex) {\n    var style = this._styles[this.getStyleId(rowIndex, cellIndex)];\n\n    return style && style.dataType || \"string\";\n  },\n  getCellData: function getCellData(rowIndex, cellIndex) {\n    var result = {};\n    var items = this._options.items;\n    var item = items[rowIndex] && items[rowIndex][cellIndex] || {};\n\n    if (\"string\" === this.getCellType(rowIndex, cellIndex)) {\n      result.value = item.text;\n    } else {\n      result.value = item.value;\n    }\n\n    return result;\n  },\n  getStyles: function getStyles() {\n    return this._styles;\n  },\n  getStyleId: function getStyleId(rowIndex, cellIndex) {\n    var items = this._options.items;\n    var columnHeaderSize = items[0][0].rowspan;\n    var rowHeaderSize = items[0][0].colspan;\n    var item = items[rowIndex] && items[rowIndex][cellIndex] || {};\n\n    if (0 === cellIndex && 0 === rowIndex) {\n      return COLUMN_HEADER_STYLE_ID;\n    } else {\n      if (cellIndex >= rowHeaderSize && rowIndex < columnHeaderSize) {\n        return COLUMN_HEADER_STYLE_ID;\n      } else {\n        if (rowIndex >= columnHeaderSize && cellIndex < rowHeaderSize) {\n          return ROW_HEADER_STYLE_ID;\n        }\n      }\n    }\n\n    return DATA_STYLE_OFFSET + (item.dataIndex || 0);\n  },\n  hasCustomizeExcelCell: function hasCustomizeExcelCell() {\n    return (0, _type.isDefined)(this._options.customizeExcelCell);\n  },\n  customizeExcelCell: function customizeExcelCell(e) {\n    if (this._options.customizeExcelCell) {\n      this._options.customizeExcelCell(e);\n    }\n  }\n});","map":null,"metadata":{},"sourceType":"script"}