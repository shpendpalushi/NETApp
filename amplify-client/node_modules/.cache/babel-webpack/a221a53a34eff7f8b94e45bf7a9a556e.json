{"ast":null,"code":"/**\r\n * DevExtreme (viz/core/annotations.js)\r\n * Version: 19.2.6\r\n * Build date: Thu Jan 30 2020\r\n *\r\n * Copyright (c) 2012 - 2020 Developer Express Inc. ALL RIGHTS RESERVED\r\n * Read about DevExtreme licensing here: https://js.devexpress.com/Licensing/\r\n */\n\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.plugins = exports.__test_utils = exports.createAnnotations = void 0;\n\nvar _dom_adapter = require(\"../../core/dom_adapter\");\n\nvar _type = require(\"../../core/utils/type\");\n\nvar _tooltip = require(\"../core/tooltip\");\n\nvar _extend = require(\"../../core/utils/extend\");\n\nvar _utils = require(\"./utils\");\n\nvar _plaque = require(\"./plaque\");\n\nvar _pointer = require(\"../../events/pointer\");\n\nvar _pointer2 = _interopRequireDefault(_pointer);\n\nvar _drag = require(\"../../events/drag\");\n\nvar _drag2 = _interopRequireDefault(_drag);\n\nvar _utils2 = require(\"../../events/utils\");\n\nvar _events_engine = require(\"../../events/core/events_engine\");\n\nvar _events_engine2 = _interopRequireDefault(_events_engine);\n\nfunction _interopRequireDefault(obj) {\n  return obj && obj.__esModule ? obj : {\n    \"default\": obj\n  };\n}\n\nvar EVENT_NS = \"annotations\";\nvar DOT_EVENT_NS = \".\" + EVENT_NS;\nvar POINTER_ACTION = (0, _utils2.addNamespace)([_pointer2.default.down, _pointer2.default.move], EVENT_NS);\nvar POINTER_UP_EVENT_NAME = (0, _utils2.addNamespace)(_pointer2.default.up, EVENT_NS);\nvar DRAG_START_EVENT_NAME = _drag2.default.start + DOT_EVENT_NS;\nvar DRAG_EVENT_NAME = _drag2.default.move + DOT_EVENT_NS;\nvar DRAG_END_EVENT_NAME = _drag2.default.end + DOT_EVENT_NS;\n\nfunction coreAnnotation(options, contentTemplate) {\n  return {\n    type: options.type,\n    name: options.name,\n    x: options.x,\n    y: options.y,\n    value: options.value,\n    argument: options.argument,\n    axis: options.axis,\n    series: options.series,\n    options: options,\n    offsetX: options.offsetX,\n    offsetY: options.offsetY,\n    draw: function draw(widget, group) {\n      var _this = this;\n\n      var annotationGroup = widget._renderer.g().append(group).css((0, _utils.patchFontOptions)(options.font));\n\n      this.plaque = new _plaque.Plaque(options, widget, annotationGroup, contentTemplate, (0, _type.isDefined)(options.value) || (0, _type.isDefined)(options.argument));\n      this.plaque.draw(widget._getAnnotationCoords(this));\n\n      if (options.allowDragging) {\n        annotationGroup.on(DRAG_START_EVENT_NAME, {\n          immediate: true\n        }, function (e) {\n          _this._dragOffsetX = _this.plaque.x - e.pageX;\n          _this._dragOffsetY = _this.plaque.y - e.pageY;\n        }).on(DRAG_EVENT_NAME, function (e) {\n          _this.plaque.move(e.pageX + _this._dragOffsetX, e.pageY + _this._dragOffsetY);\n        }).on(DRAG_END_EVENT_NAME, function (e) {\n          _this.offsetX = (_this.offsetX || 0) + e.offset.x;\n          _this.offsetY = (_this.offsetY || 0) + e.offset.y;\n        });\n      }\n    },\n    hitTest: function hitTest(x, y) {\n      return this.plaque.hitTest(x, y);\n    },\n    showTooltip: function showTooltip(tooltip, _ref) {\n      var x = _ref.x,\n          y = _ref.y;\n\n      if (tooltip.annotation !== this) {\n        tooltip.setTemplate(this.options.tooltipTemplate);\n\n        if (tooltip.show(this.options, {\n          x: x,\n          y: y\n        }, {\n          target: this.options\n        }, this.options.customizeTooltip)) {\n          tooltip.annotation = this;\n        }\n      } else {\n        tooltip.move(x, y);\n      }\n    }\n  };\n}\n\nfunction getTemplateFunction(options, widget) {\n  var template;\n\n  if (\"text\" === options.type) {\n    template = function template(item, groupElement) {\n      var text = widget._renderer.text(item.text).attr({\n        \"class\": item.cssClass\n      }).append({\n        element: groupElement\n      });\n\n      if (item.width > 0 || item.height > 0) {\n        text.setMaxSize(item.width, item.height, {\n          wordWrap: item.wordWrap,\n          textOverflow: item.textOverflow\n        });\n      }\n    };\n  } else {\n    if (\"image\" === options.type) {\n      template = function template(item, groupElement) {\n        var _ref2 = item.image || {},\n            width = _ref2.width,\n            height = _ref2.height,\n            url = _ref2.url,\n            location = _ref2.location;\n\n        var outerWidth = item.width,\n            outerHeight = item.height;\n        var imageWidth = outerWidth > 0 ? Math.min(width, outerWidth) : width;\n        var imageHeight = outerHeight > 0 ? Math.min(height, outerHeight) : height;\n\n        widget._renderer.image(0, 0, imageWidth, imageHeight, url, location || \"center\").append({\n          element: groupElement\n        });\n      };\n    } else {\n      if (\"custom\" === options.type) {\n        template = options.template;\n      }\n    }\n  }\n\n  return template;\n}\n\nvar createAnnotations = exports.createAnnotations = function (widget, items) {\n  var commonAnnotationSettings = arguments.length > 2 && void 0 !== arguments[2] ? arguments[2] : {};\n  var customizeAnnotation = arguments.length > 3 ? arguments[3] : void 0;\n  return items.reduce(function (arr, item) {\n    var options = (0, _extend.extend)(true, {}, commonAnnotationSettings, item, customizeAnnotation && customizeAnnotation.call ? customizeAnnotation(item) : {});\n    var templateFunction = getTemplateFunction(options, widget);\n    var annotation = templateFunction && coreAnnotation(options, widget._getTemplate(templateFunction));\n    annotation && arr.push(annotation);\n    return arr;\n  }, []);\n};\n\nvar chartPlugin = {\n  name: \"annotations_chart\",\n  init: function init() {},\n  dispose: function dispose() {},\n  members: {\n    _getAnnotationCoords: function _getAnnotationCoords(annotation) {\n      var coords = {\n        offsetX: annotation.offsetX,\n        offsetY: annotation.offsetY\n      };\n      var argCoordName = this._options.rotated ? \"y\" : \"x\";\n      var valCoordName = this._options.rotated ? \"x\" : \"y\";\n      var argAxis = this.getArgumentAxis();\n      var argument = argAxis.validateUnit(annotation.argument);\n      var axis = this.getValueAxis(annotation.axis);\n      var series;\n      var pane = (0, _type.isDefined)(axis) ? axis.pane : void 0;\n\n      if (annotation.series) {\n        series = this.series.filter(function (s) {\n          return s.name === annotation.series;\n        })[0];\n        axis = series && series.getValueAxis();\n        (0, _type.isDefined)(axis) && (pane = axis.pane);\n      }\n\n      if ((0, _type.isDefined)(argument)) {\n        if (series) {\n          var center = series.getPointCenterByArg(argument);\n          center && (coords[argCoordName] = center[argCoordName]);\n        } else {\n          coords[argCoordName] = argAxis.getTranslator().translate(argument);\n        }\n\n        !(0, _type.isDefined)(pane) && (pane = argAxis.pane);\n      }\n\n      var value = axis && axis.validateUnit(annotation.value);\n\n      if ((0, _type.isDefined)(value)) {\n        coords[valCoordName] = axis && axis.getTranslator().translate(value);\n        !(0, _type.isDefined)(pane) && (0, _type.isDefined)(axis) && (pane = axis.pane);\n      }\n\n      coords.canvas = this._getCanvasForPane(pane);\n\n      if ((0, _type.isDefined)(coords[argCoordName]) && !(0, _type.isDefined)(value)) {\n        if (!(0, _type.isDefined)(axis) && !(0, _type.isDefined)(series)) {\n          coords[valCoordName] = argAxis.getAxisPosition();\n        } else {\n          if ((0, _type.isDefined)(axis) && !(0, _type.isDefined)(series)) {\n            coords[valCoordName] = this._argumentAxes.filter(function (a) {\n              return a.pane === axis.pane;\n            })[0].getAxisPosition();\n          } else {\n            if ((0, _type.isDefined)(series) && series.checkSeriesViewportCoord(argAxis, coords[argCoordName])) {\n              coords[valCoordName] = series.getSeriesPairCoord(coords[argCoordName], true);\n            }\n          }\n        }\n      }\n\n      if (!(0, _type.isDefined)(argument) && (0, _type.isDefined)(coords[valCoordName])) {\n        if ((0, _type.isDefined)(axis) && !(0, _type.isDefined)(series)) {\n          coords[argCoordName] = axis.getAxisPosition();\n        } else {\n          if ((0, _type.isDefined)(series)) {\n            if (series.checkSeriesViewportCoord(axis, coords[valCoordName])) {\n              coords[argCoordName] = series.getSeriesPairCoord(coords[valCoordName], false);\n            }\n          }\n        }\n      }\n\n      return coords;\n    },\n    _annotationsPointerEventHandler: function _annotationsPointerEventHandler(event) {\n      var originalEvent = event.originalEvent || {};\n      var touch = originalEvent.touches && originalEvent.touches[0] || {};\n\n      var rootOffset = this._renderer.getRootOffset();\n\n      var coords = {\n        x: touch.pageX || originalEvent.pageX || event.pageX,\n        y: touch.pageY || originalEvent.pageY || event.pageY\n      };\n\n      var annotation = this._annotations.items.filter(function (a) {\n        return a.hitTest(coords.x - rootOffset.left, coords.y - rootOffset.top);\n      })[0];\n\n      if (!annotation || !annotation.options.tooltipEnabled) {\n        this._annotations.hideTooltip();\n\n        return;\n      }\n\n      this.hideTooltip();\n      this.clearHover();\n\n      if (annotation.options.allowDragging && event.type === _pointer2.default.down) {\n        this._annotations._hideToolTipForDrag = true;\n      }\n\n      if (!this._annotations._hideToolTipForDrag) {\n        annotation.showTooltip(this._annotations.tooltip, coords);\n        event.stopPropagation();\n      }\n    }\n  }\n};\nvar corePlugin = {\n  name: \"annotations_core\",\n  init: function init() {\n    this._annotations = {\n      items: [],\n      _hideToolTipForDrag: false,\n      tooltip: new _tooltip.Tooltip({\n        cssClass: \"\".concat(this._rootClassPrefix, \"-annotation-tooltip\"),\n        eventTrigger: this._eventTrigger,\n        widgetRoot: this.element(),\n        widget: this\n      }),\n      hideTooltip: function hideTooltip() {\n        this.tooltip.annotation = null;\n        this.tooltip.hide();\n      }\n    };\n\n    this._annotations.tooltip.setRendererOptions(this._getRendererOptions());\n\n    var tooltipOptions = (0, _extend.extend)({}, this._themeManager.getOptions(\"tooltip\"));\n    tooltipOptions.contentTemplate = tooltipOptions.customizeTooltip = void 0;\n\n    this._annotations.tooltip.update(tooltipOptions);\n  },\n  dispose: function dispose() {\n    this._annotationsGroup.linkRemove().linkOff();\n\n    _events_engine2.default.off((0, _dom_adapter.getDocument)(), DOT_EVENT_NS);\n\n    this._annotationsGroup.off(DOT_EVENT_NS);\n\n    this._annotations.tooltip && this._annotations.tooltip.dispose();\n  },\n  extenders: {\n    _createHtmlStructure: function _createHtmlStructure() {\n      var _this2 = this;\n\n      this._annotationsGroup = this._renderer.g().attr({\n        \"class\": \"\".concat(this._rootClassPrefix, \"-annotations\")\n      }).linkOn(this._renderer.root, \"annotations\").linkAppend();\n\n      _events_engine2.default.on((0, _dom_adapter.getDocument)(), POINTER_ACTION, function () {\n        return _this2._annotations.hideTooltip();\n      });\n\n      _events_engine2.default.on((0, _dom_adapter.getDocument)(), POINTER_UP_EVENT_NAME, function (event) {\n        _this2._annotations._hideToolTipForDrag = false;\n\n        _this2._annotationsPointerEventHandler(event);\n      });\n\n      this._annotationsGroup.on(POINTER_ACTION, this._annotationsPointerEventHandler.bind(this));\n    },\n    _renderExtraElements: function _renderExtraElements() {\n      var _this3 = this;\n\n      this._annotationsGroup.clear();\n\n      this._annotations.items.forEach(function (item) {\n        return item.draw(_this3, _this3._annotationsGroup);\n      });\n    },\n    _stopCurrentHandling: function _stopCurrentHandling() {\n      this._annotations.hideTooltip();\n    }\n  },\n  members: {\n    _buildAnnotations: function _buildAnnotations() {\n      this._annotations.items = [];\n\n      var items = this._getOption(\"annotations\");\n\n      if (!items || !items.length) {\n        return;\n      }\n\n      this._annotations.items = createAnnotations(this, items, this._getOption(\"commonAnnotationSettings\"), this._getOption(\"customizeAnnotation\"));\n    },\n    _getAnnotationCoords: function _getAnnotationCoords() {\n      return {};\n    }\n  },\n  customize: function customize(constructor) {\n    constructor.addChange({\n      code: \"ANNOTATIONITEMS\",\n      handler: function handler() {\n        this._requestChange([\"ANNOTATIONS\"]);\n      },\n      isOptionChange: true,\n      option: \"annotations\"\n    });\n    constructor.addChange({\n      code: \"ANNOTATIONSSETTINGS\",\n      handler: function handler() {\n        this._requestChange([\"ANNOTATIONS\"]);\n      },\n      isOptionChange: true,\n      option: \"commonAnnotationSettings\"\n    });\n    constructor.addChange({\n      code: \"ANNOTATIONS\",\n      handler: function handler() {\n        this._buildAnnotations();\n\n        this._change([\"FORCE_RENDER\"]);\n      },\n      isThemeDependent: true,\n      isOptionChange: true\n    });\n  },\n  fontFields: [\"commonAnnotationSettings.font\"]\n};\nvar plugins = exports.plugins = {\n  core: corePlugin,\n  chart: chartPlugin\n};","map":null,"metadata":{},"sourceType":"script"}