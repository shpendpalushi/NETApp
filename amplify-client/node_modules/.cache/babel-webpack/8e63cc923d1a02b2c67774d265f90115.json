{"ast":null,"code":"/**\r\n * DevExtreme (ui/html_editor/modules/mentions.js)\r\n * Version: 19.2.6\r\n * Build date: Thu Jan 30 2020\r\n *\r\n * Copyright (c) 2012 - 2020 Developer Express Inc. ALL RIGHTS RESERVED\r\n * Read about DevExtreme licensing here: https://js.devexpress.com/Licensing/\r\n */\n\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nvar _renderer = require(\"../../../core/renderer\");\n\nvar _renderer2 = _interopRequireDefault(_renderer);\n\nvar _data = require(\"../../../core/utils/data\");\n\nvar _type = require(\"../../../core/utils/type\");\n\nvar _extend = require(\"../../../core/utils/extend\");\n\nvar _dom = require(\"../../../core/utils/dom\");\n\nvar _events = require(\"../../../events\");\n\nvar _popup = require(\"./popup\");\n\nvar _popup2 = _interopRequireDefault(_popup);\n\nvar _mention = require(\"../formats/mention\");\n\nvar _mention2 = _interopRequireDefault(_mention);\n\nfunction _interopRequireDefault(obj) {\n  return obj && obj.__esModule ? obj : {\n    \"default\": obj\n  };\n}\n\nfunction _typeof(obj) {\n  if (\"function\" === typeof Symbol && \"symbol\" === typeof Symbol.iterator) {\n    _typeof = function _typeof(obj) {\n      return typeof obj;\n    };\n  } else {\n    _typeof = function _typeof(obj) {\n      return obj && \"function\" === typeof Symbol && obj.constructor === Symbol && obj !== Symbol.prototype ? \"symbol\" : typeof obj;\n    };\n  }\n\n  return _typeof(obj);\n}\n\nfunction _classCallCheck(instance, Constructor) {\n  if (!(instance instanceof Constructor)) {\n    throw new TypeError(\"Cannot call a class as a function\");\n  }\n}\n\nfunction _possibleConstructorReturn(self, call) {\n  if (call && (\"object\" === _typeof(call) || \"function\" === typeof call)) {\n    return call;\n  }\n\n  return _assertThisInitialized(self);\n}\n\nfunction _assertThisInitialized(self) {\n  if (void 0 === self) {\n    throw new ReferenceError(\"this hasn't been initialised - super() hasn't been called\");\n  }\n\n  return self;\n}\n\nfunction _defineProperties(target, props) {\n  for (var i = 0; i < props.length; i++) {\n    var descriptor = props[i];\n    descriptor.enumerable = descriptor.enumerable || false;\n    descriptor.configurable = true;\n\n    if (\"value\" in descriptor) {\n      descriptor.writable = true;\n    }\n\n    Object.defineProperty(target, descriptor.key, descriptor);\n  }\n}\n\nfunction _createClass(Constructor, protoProps, staticProps) {\n  if (protoProps) {\n    _defineProperties(Constructor.prototype, protoProps);\n  }\n\n  if (staticProps) {\n    _defineProperties(Constructor, staticProps);\n  }\n\n  return Constructor;\n}\n\nfunction _inherits(subClass, superClass) {\n  if (\"function\" !== typeof superClass && null !== superClass) {\n    throw new TypeError(\"Super expression must either be null or a function\");\n  }\n\n  subClass.prototype = Object.create(superClass && superClass.prototype, {\n    constructor: {\n      value: subClass,\n      writable: true,\n      configurable: true\n    }\n  });\n\n  if (superClass) {\n    _setPrototypeOf(subClass, superClass);\n  }\n}\n\nfunction _setPrototypeOf(o, p) {\n  _setPrototypeOf = Object.setPrototypeOf || function (o, p) {\n    o.__proto__ = p;\n    return o;\n  };\n\n  return _setPrototypeOf(o, p);\n}\n\nfunction _get(target, property, receiver) {\n  if (\"undefined\" !== typeof Reflect && Reflect.get) {\n    _get = Reflect.get;\n  } else {\n    _get = function _get(target, property, receiver) {\n      var base = _superPropBase(target, property);\n\n      if (!base) {\n        return;\n      }\n\n      var desc = Object.getOwnPropertyDescriptor(base, property);\n\n      if (desc.get) {\n        return desc.get.call(receiver);\n      }\n\n      return desc.value;\n    };\n  }\n\n  return _get(target, property, receiver || target);\n}\n\nfunction _superPropBase(object, property) {\n  while (!Object.prototype.hasOwnProperty.call(object, property)) {\n    object = _getPrototypeOf(object);\n\n    if (null === object) {\n      break;\n    }\n  }\n\n  return object;\n}\n\nfunction _getPrototypeOf(o) {\n  _getPrototypeOf = Object.setPrototypeOf ? Object.getPrototypeOf : function (o) {\n    return o.__proto__ || Object.getPrototypeOf(o);\n  };\n  return _getPrototypeOf(o);\n}\n\nvar USER_ACTION = \"user\";\nvar SILENT_ACTION = \"silent\";\nvar DEFAULT_MARKER = \"@\";\nvar KEY_CODES = {\n  ARROW_UP: 38,\n  ARROW_DOWN: 40,\n  ARROW_LEFT: 37,\n  ARROW_RIGHT: 39,\n  ENTER: 13,\n  ESCAPE: 27,\n  SPACE: 32,\n  PAGE_UP: 33,\n  PAGE_DOWN: 34,\n  END: 35,\n  HOME: 36\n};\nvar NAVIGATION_KEYS = [KEY_CODES.ARROW_LEFT, KEY_CODES.ARROW_RIGHT, KEY_CODES.PAGE_UP, KEY_CODES.PAGE_DOWN, KEY_CODES.END, KEY_CODES.HOME];\nvar ALLOWED_PREFIX_CHARS = [\" \", \"\\n\"];\nvar DISABLED_STATE_CLASS = \"dx-state-disabled\";\n\nvar MentionModule = function (_PopupModule) {\n  _inherits(MentionModule, _PopupModule);\n\n  _createClass(MentionModule, [{\n    key: \"_getDefaultOptions\",\n    value: function value() {\n      var baseConfig = _get(_getPrototypeOf(MentionModule.prototype), \"_getDefaultOptions\", this).call(this);\n\n      return (0, _extend.extend)(baseConfig, {\n        itemTemplate: \"item\",\n        valueExpr: \"this\",\n        displayExpr: \"this\",\n        template: null,\n        searchExpr: null,\n        searchTimeout: 500,\n        minSearchLength: 0\n      });\n    }\n  }]);\n\n  function MentionModule(quill, options) {\n    var _this;\n\n    _classCallCheck(this, MentionModule);\n\n    _this = _possibleConstructorReturn(this, _getPrototypeOf(MentionModule).call(this, quill, options));\n    _this._mentions = {};\n    _this.editorInstance = options.editorInstance;\n    options.mentions.forEach(function (item) {\n      var marker = item.marker,\n          template = item.template;\n\n      if (!marker) {\n        item.marker = marker = DEFAULT_MARKER;\n      }\n\n      if (template) {\n        var preparedTemplate = _this.editorInstance._getTemplate(template);\n\n        preparedTemplate && _mention2.default.addTemplate(marker, preparedTemplate);\n      }\n\n      _this._mentions[marker] = (0, _extend.extend)({}, _this._getDefaultOptions(), item);\n    });\n\n    _this._attachKeyboardHandlers();\n\n    _this.editorInstance.addCleanCallback(_this.clean.bind(_assertThisInitialized(_this)));\n\n    _this.quill.on(\"text-change\", _this.onTextChange.bind(_assertThisInitialized(_this)));\n\n    return _this;\n  }\n\n  _createClass(MentionModule, [{\n    key: \"_attachKeyboardHandlers\",\n    value: function value() {\n      var _this2 = this;\n\n      this.quill.keyboard.addBinding({\n        key: KEY_CODES.ARROW_UP\n      }, this._arrowUpKeyHandler.bind(this));\n      this.quill.keyboard.addBinding({\n        key: KEY_CODES.ARROW_DOWN\n      }, this._arrowDownKeyHandler.bind(this));\n      this.quill.keyboard.addBinding({\n        key: KEY_CODES.ENTER\n      }, this._selectItemHandler.bind(this));\n      var enterBindings = this.quill.keyboard.bindings[KEY_CODES.ENTER];\n      enterBindings.unshift(enterBindings.pop());\n      this.quill.keyboard.addBinding({\n        key: KEY_CODES.ESCAPE\n      }, this._escapeKeyHandler.bind(this));\n      this.quill.keyboard.addBinding({\n        key: KEY_CODES.SPACE\n      }, this._selectItemHandler.bind(this));\n      this.quill.keyboard.addBinding({\n        key: KEY_CODES.ARROW_LEFT,\n        shiftKey: true\n      }, this._ignoreKeyHandler.bind(this));\n      this.quill.keyboard.addBinding({\n        key: KEY_CODES.ARROW_RIGHT,\n        shiftKey: true\n      }, this._ignoreKeyHandler.bind(this));\n      NAVIGATION_KEYS.forEach(function (key) {\n        _this2.quill.keyboard.addBinding({\n          key: key\n        }, _this2._ignoreKeyHandler.bind(_this2));\n      });\n    }\n  }, {\n    key: \"_arrowUpKeyHandler\",\n    value: function value() {\n      if (this._isMentionActive) {\n        var $focusedItem = (0, _renderer2.default)(this._list.option(\"focusedElement\"));\n        var $prevItem = $focusedItem.prev();\n        $prevItem = $prevItem.length ? $prevItem : this._activeListItems.last();\n\n        this._list.option(\"focusedElement\", (0, _dom.getPublicElement)($prevItem));\n\n        this._list.scrollToItem($prevItem);\n      }\n\n      return !this._isMentionActive;\n    }\n  }, {\n    key: \"_arrowDownKeyHandler\",\n    value: function value() {\n      if (this._isMentionActive) {\n        var $focusedItem = (0, _renderer2.default)(this._list.option(\"focusedElement\"));\n        var $nextItem = $focusedItem.next();\n        $nextItem = $nextItem.length ? $nextItem : this._activeListItems.first();\n\n        this._list.option(\"focusedElement\", (0, _dom.getPublicElement)($nextItem));\n\n        this._list.scrollToItem($nextItem);\n      }\n\n      return !this._isMentionActive;\n    }\n  }, {\n    key: \"_ignoreKeyHandler\",\n    value: function value() {\n      return !this._isMentionActive;\n    }\n  }, {\n    key: \"_fitIntoRange\",\n    value: function value(_value, start, end) {\n      if (_value > end) {\n        return start;\n      }\n\n      if (_value < start) {\n        return end;\n      }\n\n      return _value;\n    }\n  }, {\n    key: \"_selectItemHandler\",\n    value: function value() {\n      if (this._isMentionActive) {\n        this._list.selectItem(this._list.option(\"focusedElement\"));\n      }\n\n      return !this._isMentionActive;\n    }\n  }, {\n    key: \"_escapeKeyHandler\",\n    value: function value() {\n      if (this._isMentionActive) {\n        this._popup.hide();\n      }\n\n      return !this._isMentionActive;\n    }\n  }, {\n    key: \"renderList\",\n    value: function value($container, options) {\n      this.compileGetters(this.options);\n\n      _get(_getPrototypeOf(MentionModule.prototype), \"renderList\", this).call(this, $container, options);\n    }\n  }, {\n    key: \"compileGetters\",\n    value: function value(_ref) {\n      var displayExpr = _ref.displayExpr,\n          valueExpr = _ref.valueExpr;\n      this._valueGetter = (0, _data.compileGetter)(displayExpr);\n      this._idGetter = (0, _data.compileGetter)(valueExpr);\n    }\n  }, {\n    key: \"_getListConfig\",\n    value: function value(options) {\n      var _this3 = this;\n\n      var baseConfig = _get(_getPrototypeOf(MentionModule.prototype), \"_getListConfig\", this).call(this, options);\n\n      return (0, _extend.extend)(baseConfig, {\n        itemTemplate: this.options.itemTemplate,\n        onContentReady: function onContentReady() {\n          if (_this3._hasSearch) {\n            _this3._popup.repaint();\n\n            _this3._focusFirstElement();\n\n            _this3._hasSearch = false;\n          }\n        }\n      });\n    }\n  }, {\n    key: \"insertEmbedContent\",\n    value: function value() {\n      var markerLength = this._activeMentionConfig.marker.length;\n      var textLength = markerLength + this._searchValue.length;\n      var caretPosition = this.getPosition();\n      var startIndex = Math.max(0, caretPosition - markerLength);\n\n      var selectedItem = this._list.option(\"selectedItem\");\n\n      var value = {\n        value: this._valueGetter(selectedItem),\n        id: this._idGetter(selectedItem),\n        marker: this._activeMentionConfig.marker\n      };\n      setTimeout(function () {\n        this.quill.insertText(startIndex, \" \", SILENT_ACTION);\n        this.quill.deleteText(startIndex + 1, textLength, SILENT_ACTION);\n        this.quill.insertEmbed(startIndex, \"mention\", value);\n        this.quill.setSelection(startIndex + 2);\n      }.bind(this));\n    }\n  }, {\n    key: \"_getLastInsertOperation\",\n    value: function value(ops) {\n      var lastOperation = ops[ops.length - 1];\n      var isLastOperationInsert = (\"insert\" in lastOperation);\n\n      if (isLastOperationInsert) {\n        return lastOperation;\n      }\n\n      var isLastOperationDelete = (\"delete\" in lastOperation);\n\n      if (isLastOperationDelete && ops.length >= 2) {\n        var penultOperation = ops[ops.length - 2];\n        var isPenultOperationInsert = (\"insert\" in penultOperation);\n        var isSelectionReplacing = isLastOperationDelete && isPenultOperationInsert;\n\n        if (isSelectionReplacing) {\n          return penultOperation;\n        }\n      }\n\n      return null;\n    }\n  }, {\n    key: \"onTextChange\",\n    value: function value(newDelta, oldDelta, source) {\n      if (source === USER_ACTION) {\n        var lastOperation = newDelta.ops[newDelta.ops.length - 1];\n\n        if (this._isMentionActive) {\n          this._processSearchValue(lastOperation) && this._filterList(this._searchValue);\n        } else {\n          var ops = newDelta.ops;\n\n          var lastInsertOperation = this._getLastInsertOperation(ops);\n\n          if (lastInsertOperation) {\n            this.checkMentionRequest(lastInsertOperation, ops);\n          }\n        }\n      }\n    }\n  }, {\n    key: \"_processSearchValue\",\n    value: function value(operation) {\n      var isInsertOperation = (\"insert\" in operation);\n\n      if (isInsertOperation) {\n        this._searchValue += operation.insert;\n      } else {\n        if (!this._searchValue.length) {\n          this._popup.hide();\n\n          return false;\n        } else {\n          this._searchValue = this._searchValue.slice(0, -1);\n        }\n      }\n\n      return true;\n    }\n  }, {\n    key: \"checkMentionRequest\",\n    value: function value(_ref2, ops) {\n      var insert = _ref2.insert;\n      var caret = this.quill.getSelection();\n\n      if (!insert || !(0, _type.isString)(insert) || !caret || this._isMarkerPartOfText(ops[0].retain)) {\n        return;\n      }\n\n      this._activeMentionConfig = this._mentions[insert];\n\n      if (this._activeMentionConfig) {\n        this._updateList(this._activeMentionConfig);\n\n        this.savePosition(caret.index);\n\n        this._popup.option(\"position\", this._popupPosition);\n\n        this._searchValue = \"\";\n\n        this._popup.show();\n      }\n    }\n  }, {\n    key: \"_isMarkerPartOfText\",\n    value: function value(retain) {\n      if (!retain || ALLOWED_PREFIX_CHARS.indexOf(this._getCharByIndex(retain - 1)) !== -1) {\n        return false;\n      }\n\n      return true;\n    }\n  }, {\n    key: \"_getCharByIndex\",\n    value: function value(index) {\n      return this.quill.getContents(index, 1).ops[0].insert;\n    }\n  }, {\n    key: \"_updateList\",\n    value: function value(_ref3) {\n      var dataSource = _ref3.dataSource,\n          displayExpr = _ref3.displayExpr,\n          valueExpr = _ref3.valueExpr,\n          itemTemplate = _ref3.itemTemplate,\n          searchExpr = _ref3.searchExpr;\n      this.compileGetters({\n        displayExpr: displayExpr,\n        valueExpr: valueExpr\n      });\n\n      this._list.unselectAll();\n\n      this._list.option({\n        dataSource: dataSource,\n        displayExpr: displayExpr,\n        itemTemplate: itemTemplate,\n        searchExpr: searchExpr\n      });\n    }\n  }, {\n    key: \"_filterList\",\n    value: function value(searchValue) {\n      var _this4 = this;\n\n      if (!this._isMinSearchLengthExceeded(searchValue)) {\n        this._resetFilter();\n\n        return;\n      }\n\n      var searchTimeout = this._activeMentionConfig.searchTimeout;\n\n      if (searchTimeout) {\n        clearTimeout(this._searchTimer);\n        this._searchTimer = setTimeout(function () {\n          _this4._search(searchValue);\n        }, searchTimeout);\n      } else {\n        this._search(searchValue);\n      }\n    }\n  }, {\n    key: \"_isMinSearchLengthExceeded\",\n    value: function value(searchValue) {\n      return searchValue.length >= this._activeMentionConfig.minSearchLength;\n    }\n  }, {\n    key: \"_resetFilter\",\n    value: function value() {\n      clearTimeout(this._searchTimer);\n\n      this._search(null);\n    }\n  }, {\n    key: \"_search\",\n    value: function value(searchValue) {\n      this._hasSearch = true;\n\n      this._list.option(\"searchValue\", searchValue);\n    }\n  }, {\n    key: \"_focusFirstElement\",\n    value: function value() {\n      if (!this._list) {\n        return;\n      }\n\n      var $firstItem = this._activeListItems.first();\n\n      this._list.option(\"focusedElement\", (0, _dom.getPublicElement)($firstItem));\n\n      this._list.scrollToItem($firstItem);\n    }\n  }, {\n    key: \"_getPopupConfig\",\n    value: function value() {\n      var _this5 = this;\n\n      return (0, _extend.extend)(_get(_getPrototypeOf(MentionModule.prototype), \"_getPopupConfig\", this).call(this), {\n        closeOnTargetScroll: false,\n        onShown: function onShown() {\n          _this5._isMentionActive = true;\n          _this5._hasSearch = false;\n\n          _this5._focusFirstElement();\n        },\n        onHidden: function onHidden() {\n          _this5._list.unselectAll();\n\n          _this5._list.option(\"focusedElement\", null);\n\n          _this5._isMentionActive = false;\n\n          _this5._search(null);\n        },\n        focusStateEnabled: false\n      });\n    }\n  }, {\n    key: \"clean\",\n    value: function value() {\n      var _this6 = this;\n\n      Object.keys(this._mentions).forEach(function (marker) {\n        if (_this6._mentions[marker].template) {\n          _mention2.default.removeTemplate(marker);\n        }\n      });\n    }\n  }, {\n    key: \"_popupPosition\",\n    get: function get() {\n      var position = this.getPosition();\n\n      var _this$quill$getBounds = this.quill.getBounds(position ? position - 1 : position),\n          mentionLeft = _this$quill$getBounds.left,\n          mentionTop = _this$quill$getBounds.top,\n          mentionHeight = _this$quill$getBounds.height;\n\n      var _$$offset = (0, _renderer2.default)(this.quill.root).offset(),\n          leftOffset = _$$offset.left,\n          topOffset = _$$offset.top;\n\n      var positionEvent = (0, _events.Event)(\"positionEvent\", {\n        pageX: leftOffset + mentionLeft,\n        pageY: topOffset + mentionTop\n      });\n      return {\n        of: positionEvent,\n        offset: {\n          v: mentionHeight\n        },\n        my: \"top left\",\n        at: \"top left\",\n        collision: {\n          y: \"flip\",\n          x: \"flipfit\"\n        }\n      };\n    }\n  }, {\n    key: \"_activeListItems\",\n    get: function get() {\n      return this._list.itemElements().filter(\":not(.\".concat(DISABLED_STATE_CLASS, \")\"));\n    }\n  }]);\n\n  return MentionModule;\n}(_popup2.default);\n\nexports.default = MentionModule;","map":null,"metadata":{},"sourceType":"script"}