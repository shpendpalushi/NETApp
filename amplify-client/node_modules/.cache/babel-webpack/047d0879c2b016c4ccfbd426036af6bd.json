{"ast":null,"code":"/**\r\n * DevExtreme (ui/tree_list/ui.tree_list.editing.js)\r\n * Version: 19.2.6\r\n * Build date: Thu Jan 30 2020\r\n *\r\n * Copyright (c) 2012 - 2020 Developer Express Inc. ALL RIGHTS RESERVED\r\n * Read about DevExtreme licensing here: https://js.devexpress.com/Licensing/\r\n */\n\"use strict\";\n\nrequire(\"./ui.tree_list.editor_factory\");\n\nvar _renderer = require(\"../../core/renderer\");\n\nvar _renderer2 = _interopRequireDefault(_renderer);\n\nvar _ui = require(\"../widget/ui.errors\");\n\nvar _ui2 = _interopRequireDefault(_ui);\n\nvar _type = require(\"../../core/utils/type\");\n\nvar _extend = require(\"../../core/utils/extend\");\n\nvar _deferred = require(\"../../core/utils/deferred\");\n\nvar _message = require(\"../../localization/message\");\n\nvar _message2 = _interopRequireDefault(_message);\n\nvar _uiTree_list = require(\"./ui.tree_list.core\");\n\nvar _uiTree_list2 = _interopRequireDefault(_uiTree_list);\n\nvar _uiGrid_core = require(\"../grid_core/ui.grid_core.utils\");\n\nvar _uiGrid_core2 = _interopRequireDefault(_uiGrid_core);\n\nvar _uiGrid_core3 = require(\"../grid_core/ui.grid_core.editing\");\n\nvar _uiGrid_core4 = _interopRequireDefault(_uiGrid_core3);\n\nfunction _interopRequireDefault(obj) {\n  return obj && obj.__esModule ? obj : {\n    \"default\": obj\n  };\n}\n\nvar TREELIST_EXPAND_ICON_CONTAINER_CLASS = \"dx-treelist-icon-container\";\nvar SELECT_CHECKBOX_CLASS = \"dx-select-checkbox\";\nvar DATA_EDIT_DATA_INSERT_TYPE = \"insert\";\n\nvar EditingController = _uiGrid_core4.default.controllers.editing.inherit(function () {\n  return {\n    _generateNewItem: function _generateNewItem(key) {\n      var item = this.callBase(key);\n      item.data = {\n        key: key\n      };\n      item.children = [];\n      item.level = 0;\n      item.parentKey = this.option(\"rootValue\");\n      return item;\n    },\n    _needInsertItem: function _needInsertItem(editData, changeType, items, item) {\n      var parentKey = editData.key.parentKey;\n\n      if (void 0 !== parentKey && parentKey !== this.option(\"rootValue\")) {\n        var rowIndex = _uiGrid_core2.default.getIndexByKey(parentKey, items);\n\n        if (rowIndex >= 0 && this._dataController.isRowExpanded(parentKey)) {\n          items.splice(rowIndex + 1, 0, item);\n        }\n\n        return false;\n      }\n\n      return this.callBase.apply(this, arguments);\n    },\n    _isEditColumnVisible: function _isEditColumnVisible() {\n      var result = this.callBase.apply(this, arguments);\n      var editingOptions = this.option(\"editing\");\n      return result || editingOptions && editingOptions.allowAdding;\n    },\n    _isDefaultButtonVisible: function _isDefaultButtonVisible(button, options) {\n      var result = this.callBase.apply(this, arguments);\n      var row = options.row;\n\n      if (\"add\" === button.name) {\n        return this.allowAdding(options) && row.rowIndex !== this._getVisibleEditRowIndex() && !(row.removed || row.isNewRow);\n      }\n\n      return result;\n    },\n    _getEditingButtons: function _getEditingButtons(options) {\n      var buttons = this.callBase.apply(this, arguments);\n\n      if (!options.column.buttons) {\n        buttons.unshift(this._getButtonConfig(\"add\", options));\n      }\n\n      return buttons;\n    },\n    _beforeSaveEditData: function _beforeSaveEditData(editData) {\n      var key;\n      var store;\n      var dataController = this._dataController;\n      var result = this.callBase.apply(this, arguments);\n\n      if (editData && editData.type !== DATA_EDIT_DATA_INSERT_TYPE) {\n        store = dataController && dataController.store();\n        key = store && store.key();\n\n        if (!(0, _type.isDefined)(key)) {\n          throw _ui2.default.Error(\"E1045\");\n        }\n      }\n\n      return result;\n    },\n    addRowByRowIndex: function addRowByRowIndex(rowIndex) {\n      var dataController = this.getController(\"data\");\n      var row = dataController.getVisibleRows()[rowIndex];\n      return this.addRow(row ? row.key : void 0);\n    },\n    addRow: function addRow(key) {\n      var that = this;\n      var callBase = that.callBase;\n      var dataController = that.getController(\"data\");\n\n      if (void 0 !== key && !dataController.isRowExpanded(key)) {\n        var d = new _deferred.Deferred();\n        dataController.expandRow(key).done(function () {\n          setTimeout(function () {\n            callBase.call(that, key);\n            d.resolve();\n          });\n        }).fail(d.reject);\n        return d;\n      }\n\n      if (void 0 === key) {\n        key = that.option(\"rootValue\");\n      }\n\n      callBase.call(that, key);\n    },\n    _initNewRow: function _initNewRow(options, parentKey) {\n      var dataController = this.getController(\"data\");\n      var dataSourceAdapter = dataController.dataSource();\n      var parentIdSetter = dataSourceAdapter.createParentIdSetter();\n      parentIdSetter(options.data, parentKey);\n      this.callBase.apply(this, arguments);\n    },\n    allowAdding: function allowAdding(options) {\n      return this._allowEditAction(\"allowAdding\", options);\n    },\n    _needToCloseEditableCell: function _needToCloseEditableCell($targetElement) {\n      return this.callBase.apply(this, arguments) || $targetElement.closest(\".\" + TREELIST_EXPAND_ICON_CONTAINER_CLASS).length && this.isEditing();\n    },\n    getButtonLocalizationNames: function getButtonLocalizationNames() {\n      var names = this.callBase.apply(this);\n      names.add = \"dxTreeList-editingAddRowToNode\";\n      return names;\n    }\n  };\n}());\n\nvar originalRowClick = _uiGrid_core4.default.extenders.views.rowsView._rowClick;\nvar originalRowDblClick = _uiGrid_core4.default.extenders.views.rowsView._rowDblClick;\n\nvar validateClick = function validateClick(e) {\n  var $targetElement = (0, _renderer2.default)(e.event.target);\n  var originalClickHandler = \"dxdblclick\" === e.event.type ? originalRowDblClick : originalRowClick;\n\n  if ($targetElement.closest(\".\" + SELECT_CHECKBOX_CLASS).length) {\n    return false;\n  }\n\n  return !needToCallOriginalClickHandler.call(this, e, originalClickHandler);\n};\n\nvar needToCallOriginalClickHandler = function needToCallOriginalClickHandler(e, originalClickHandler) {\n  var $targetElement = (0, _renderer2.default)(e.event.target);\n\n  if (!$targetElement.closest(\".\" + TREELIST_EXPAND_ICON_CONTAINER_CLASS).length) {\n    originalClickHandler.call(this, e);\n    return true;\n  }\n\n  return false;\n};\n\nvar RowsViewExtender = (0, _extend.extend)({}, _uiGrid_core4.default.extenders.views.rowsView, {\n  _renderCellCommandContent: function _renderCellCommandContent($container, options) {\n    var editingController = this._editingController;\n    var isEditRow = options.row && editingController.isEditRow(options.row.rowIndex);\n    var isEditing = options.isEditing || isEditRow;\n\n    if (!isEditing) {\n      return this.callBase.apply(this, arguments);\n    }\n\n    return false;\n  },\n  _rowClick: function _rowClick(e) {\n    if (validateClick.call(this, e)) {\n      this.callBase.apply(this, arguments);\n    }\n  },\n  _rowDblClick: function _rowDblClick(e) {\n    if (validateClick.call(this, e)) {\n      this.callBase.apply(this, arguments);\n    }\n  }\n});\n\n_uiTree_list2.default.registerModule(\"editing\", {\n  defaultOptions: function defaultOptions() {\n    return (0, _extend.extend)(true, _uiGrid_core4.default.defaultOptions(), {\n      editing: {\n        texts: {\n          addRowToNode: _message2.default.format(\"dxTreeList-editingAddRowToNode\")\n        }\n      }\n    });\n  },\n  controllers: {\n    editing: EditingController\n  },\n  extenders: {\n    controllers: (0, _extend.extend)(true, {}, _uiGrid_core4.default.extenders.controllers, {\n      data: {\n        changeRowExpand: function changeRowExpand() {\n          this._editingController.refresh();\n\n          return this.callBase.apply(this, arguments);\n        }\n      }\n    }),\n    views: {\n      rowsView: RowsViewExtender,\n      headerPanel: _uiGrid_core4.default.extenders.views.headerPanel\n    }\n  }\n});","map":null,"metadata":{},"sourceType":"script"}